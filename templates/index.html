<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade Case Battle</title>
    <style>
        /* === ОСНОВНОЙ СТИЛЬ === */
        body {
            background-color: #121212;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }

        /* Отображение баланса */
        .header-balance {
            position: absolute;
            top: 20px;
            right: 40px;
            background: #1e1e1e;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #333;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            gap: 10px;
        }
        .balance-amount { color: #ffcc00; }

        /* Контейнер апгрейда */
        .upgrade-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 60px; /* Расстояние между кейсами и рулеткой */
            padding: 50px;
            background: #161616;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Карточки оружия */
        .item-card {
            background: #202020;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            width: 220px;
            position: relative;
            border: 1px solid #333;
            transition: transform 0.2s;
        }
        
        .item-card h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
        }

        .weapon-img {
            width: 100%;
            height: auto;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
        }

        .price-tag {
            margin-top: 15px;
            font-weight: bold;
            color: #fff;
        }

        /* === РУЛЕТКА (Центр) === */
        .roulette-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        /* Стрелка-указатель */
        .roulette-marker {
            position: absolute;
            top: -15px;
            z-index: 20;
            font-size: 24px;
            color: white;
            filter: drop-shadow(0 0 2px #000);
            /* Стрелка смотрит вниз */
            transform: scaleY(0.8); 
        }

        /* Вращающееся кольцо */
        .roulette-ring {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            /* Градиент задается в JS */
            background: conic-gradient(#ffcc00 0% 32.29%, #2a2a2a 32.29% 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transition: box-shadow 0.3s ease;
            position: relative;
        }

        /* Эффекты свечения */
        .roulette-ring.win-glow {
            box-shadow: 0 0 20px #00ff00, 0 0 50px #00ff00;
        }
        .roulette-ring.lose-glow {
            box-shadow: 0 0 20px #ff0000, 0 0 50px #ff0000;
        }

        /* Внутренний круг (дырка бублика) */
        .roulette-inner {
            width: 250px;
            height: 250px;
            background: #161616;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 15;
            position: relative;
            overflow: hidden;
        }

        /* Логотип в центре */
        .center-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 2px solid #333;
        }

        /* Текст результата */
        .result-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 30;
        }
        
        .result-overlay.show {
            opacity: 1;
        }

        .result-text {
            font-size: 32px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .text-win { color: #00ff00; text-shadow: 0 0 20px #00ff00; }
        .text-lose { color: #ff0000; text-shadow: 0 0 20px #ff0000; }

        /* Процент шанса */
        .chance-display {
            font-size: 28px;
            font-weight: bold;
            color: #ffcc00;
        }
        .chance-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        /* Кнопка */
        .upgrade-btn {
            margin-top: 30px;
            padding: 15px 50px;
            background: linear-gradient(90deg, #ffcc00, #ffaa00);
            border: none;
            color: #111;
            font-size: 16px;
            font-weight: 800;
            border-radius: 4px;
            cursor: pointer;
            text-transform: uppercase;
            transition: filter 0.2s;
            box-shadow: 0 4px 15px rgba(255, 204, 0, 0.3);
        }
        
        .upgrade-btn:hover {
            filter: brightness(1.1);
        }
        .upgrade-btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Адаптив для мобильных */
        @media (max-width: 800px) {
            .upgrade-container {
                flex-direction: column;
                padding: 20px;
            }
        }
    </style>
</head>
<body>

    <div class="header-balance">
        <span>Баланс:</span>
        <span id="userBalanceDisplay" class="balance-amount">Loading...</span>
        <span>★</span>
    </div>

    <div class="upgrade-container">
        
        <div class="item-card">
            <h3>Твой предмет</h3>
            <img src="https://via.placeholder.com/200x120?text=M4A1-S" alt="Weapon In" class="weapon-img">
            <div class="price-tag">1000 P</div>
        </div>

        <div class="roulette-wrapper">
            <div class="roulette-marker">▼</div>

            <div class="roulette-ring" id="rouletteRing">
                <div class="roulette-inner">
                    <img src="https://via.placeholder.com/80?text=LOGO" alt="Tung Tung Sahur" class="center-logo" id="centerLogo">
                    
                    <div class="chance-display">32.29%</div>
                    <div class="chance-label">шанс успеха</div>

                    <div id="resultOverlay" class="result-overlay">
                        <div id="resultText" class="result-text"></div>
                    </div>
                </div>
            </div>

            <button onclick="runUpgrade()" id="upgradeBtn" class="upgrade-btn">UPGRADE</button>
        </div>

        <div class="item-card">
            <h3>Цель</h3>
            <img src="https://i.imgur.com/kQQXAj8.jpg" onerror="this.src='https://via.placeholder.com/200x120?text=Target+Item'" alt="Target Case" class="weapon-img">
            <div class="price-tag">44165.5 P</div>
        </div>

    </div>

    <script>
        // === НАСТРОЙКИ ===
        const winChance = 32.29; // Шанс с сервера
        const ring = document.getElementById('rouletteRing');
        const resultOverlay = document.getElementById('resultOverlay');
        const resultText = document.getElementById('resultText');
        const upgradeBtn = document.getElementById('upgradeBtn');
        const balanceDisplay = document.getElementById('userBalanceDisplay');

        // Инициализация градиента рулетки
        // Желтый сектор (победа) от 0 до winChance%
        ring.style.background = `conic-gradient(#ffcc00 0% ${winChance}%, #2a2a2a ${winChance}% 100%)`;

        // === ФУНКЦИЯ ЗАПУСКА ИГРЫ ===
        async function runUpgrade() {
            // 1. Блокируем кнопку
            upgradeBtn.disabled = true;
            
            // 2. Сброс стилей
            ring.style.transition = 'none';
            ring.style.transform = 'rotate(0deg)';
            ring.classList.remove('win-glow', 'lose-glow');
            resultOverlay.classList.remove('show');
            resultText.className = 'result-text';

            // 3. (ВАЖНО) Здесь должен быть запрос к твоему серверу
            // const response = await fetch('/api/upgrade', { method: 'POST' });
            // const data = await response.json();
            // const isWin = data.success; // true или false от сервера
            
            // --- СИМУЛЯЦИЯ СЕРВЕРА (УДАЛИ ЭТОТ БЛОК КОГДА ПОДКЛЮЧИШЬ API) ---
            const roll = Math.random() * 100;
            const isWin = roll < winChance;
            console.log("Результат:", isWin ? "WIN" : "LOSE", "Roll:", roll);
            // ----------------------------------------------------------------

            // 4. Расчет угла остановки
            // Нам нужно прокрутить, например, 5 оборотов (360 * 5) + угол остановки.
            // У CSS conic-gradient 0 градусов обычно сверху (12 часов).
            // Чтобы нужный сектор оказался под стрелкой, нужно повернуть колесо в минус.
            
            let targetDegree;

            if (isWin) {
                // Если победа: выбираем случайную точку внутри желтого сектора (0...winChance)
                // Чтобы эта точка оказалась наверху, вращаем: -(точка).
                // Пример: сектор 0-30. Выпало 15. Вращаем на -15deg (плюс обороты).
                const randomSpot = Math.random() * winChance;
                targetDegree = randomSpot;
            } else {
                // Если проигрыш: выбираем точку в сером секторе (winChance...100)
                // Конвертируем проценты в градусы: (x / 100) * 360
                const randomPercent = winChance + (Math.random() * (100 - winChance));
                targetDegree = (randomPercent / 100) * 360;
            }

            // Добавляем 5 полных оборотов + смещение, чтобы крутилось против часовой (или по часовой, если минус)
            // Чтобы крутилось по часовой и встало нужным местом вверх:
            // Rotate = (360 * 5) - targetDegree
            const totalRotation = (360 * 5) - targetDegree;

            // 5. Запуск анимации (небольшая задержка, чтобы браузер понял сброс)
            setTimeout(() => {
                ring.style.transition = "transform 4s cubic-bezier(0.15, 0, 0.20, 1)";
                ring.style.transform = `rotate(${totalRotation}deg)`;
            }, 50);

            // 6. Показ результата
            setTimeout(() => {
                resultOverlay.classList.add('show');
                
                if (isWin) {
                    resultText.innerText = "УСПЕХ";
                    resultText.classList.add('text-win');
                    ring.classList.add('win-glow');
                    // Тут можно обновить картинку слева на новую
                } else {
                    resultText.innerText = "НЕУДАЧА";
                    resultText.classList.add('text-lose');
                    ring.classList.add('lose-glow');
                    // Тут можно затемнить картинку предмета
                }
                
                upgradeBtn.disabled = false;
                
                // Принудительно обновляем баланс после игры
                updateBalance(); 

            }, 4050); // Ждем 4 секунды (время анимации) + 50мс
        }

        // === ОБНОВЛЕНИЕ БАЛАНСА (POLLING) ===
        // Эта функция решает проблему с обновлением звезд только после перезахода
        async function updateBalance() {
            try {
                // !!! ЗАМЕНИ URL НИЖЕ НА ТВОЙ РЕАЛЬНЫЙ API ПУТЬ !!!
                // Например: '/api/user/get-balance' или 'get_user_info.php'
                // const response = await fetch('/api/get-balance'); 
                // const data = await response.json();
                
                // СИМУЛЯЦИЯ ОТВЕТА СЕРВЕРА (для демонстрации)
                // Удали этот блок и раскомментируй fetch выше
                const data = { balance: Math.floor(Math.random() * 50000) }; 

                // Обновляем текст на странице
                if(data.balance !== undefined) {
                    balanceDisplay.innerText = data.balance.toLocaleString(); 
                }

            } catch (error) {
                console.error("Ошибка получения баланса:", error);
            }
        }

        // Запускаем обновление баланса каждые 2 секунды
        setInterval(updateBalance, 2000);
        
        // Первичный запуск
        updateBalance();

    </script>
</body>
</html>