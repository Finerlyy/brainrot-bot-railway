<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brainrot Drop</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #121214; --card: #1e1e22; --accent: #FFD700; --text-muted: #8a8a93; }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { background: var(--bg); color: #fff; font-family: 'Montserrat', sans-serif; padding-bottom: 90px; overflow-x: hidden; }
        .hidden { display: none !important; }
        
        /* Animation */
        @keyframes neonPulse { 50% { box-shadow: 0 0 15px var(--glow-color), inset 0 0 5px var(--glow-color); border-color: #fff; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes smoothZoom { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* UI Elements */
        #loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 999; display:flex; justify-content:center; align-items:center; }
        .spinner { width:40px; height:40px; border:4px solid #333; border-top:4px solid var(--accent); border-radius:50%; animation: spin 1s linear infinite; }
        
        header { display: flex; justify-content: space-between; padding: 15px 20px; background: rgba(30,30,35,0.9); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .logo { font-weight: 900; font-size: 1.1rem; } .logo span { color: var(--accent); }
        .balance-badge { background: rgba(255, 215, 0, 0.1); color: #FFD700; font-weight: 700; border: 1px solid rgba(255, 215, 0, 0.2); padding: 6px 14px; border-radius: 20px; }

        .tab-content { display: none; padding: 15px; animation: smoothZoom 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .tab-content.active { display: block; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 12px; }
        
        /* CARD STYLES */
        .card { 
            background: var(--card); padding: 10px; border-radius: 18px; text-align: center; 
            border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; position: relative; overflow: hidden; 
            aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .card:active { transform: scale(0.96); background: #252529; }
        .card img { width: 70%; height: 70%; object-fit: cover; margin-bottom: 8px; border-radius: 16px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }
        .card-name { font-weight: 700; margin-bottom: 4px; font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .card-price { color: var(--text-muted); font-size: 0.7rem; font-weight: 600; }
        
        /* Rarity & Neon */
        .rarity-Common { border-color: #666; } 
        .rarity-Uncommon { border-color: #5e98d9; } 
        .rarity-Rare { border-color: #4b69ff; } 
        .rarity-Mythical { border-color: #d32ce6; }
        .rarity-Legendary { border-color: #ff9900; }
        .rarity-Immortal { border-color: #00ffff; }
        .rarity-Secret { border-color: #ff0000; }
        
        .mutated { animation: neonPulse 2s infinite ease-in-out; border: 1px solid var(--glow-color) !important; }
        .mut-badge { position: absolute; top: 5px; left: 5px; font-size: 0.8rem; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .qty-badge { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.6); color: #fff; font-size: 0.7rem; padding: 2px 6px; border-radius: 6px; font-weight: bold; }

        .sell-btn { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); color: #fff; border: none; font-size: 0.7rem; padding: 6px; cursor: pointer; font-weight: 600; opacity: 0; transition: 0.2s; z-index: 20; }
        .card:hover .sell-btn { opacity: 1; }

        /* Buttons & Nav */
        .btn { background: linear-gradient(135deg, #FFD700, #FDB931); border: none; padding: 14px; border-radius: 16px; font-weight: 800; font-size: 0.95rem; color: #1a1a1a; cursor: pointer; box-shadow: 0 5px 15px -5px var(--accent-glow); width: 100%; text-transform: uppercase; letter-spacing: 0.5px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn:disabled { opacity: 0.6; filter: grayscale(1); cursor: not-allowed; }
        
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(30, 30, 35, 0.95); backdrop-filter: blur(20px); display: flex; padding: 10px 0 20px 0; border-top: 1px solid rgba(255,255,255,0.05); z-index: 50; justify-content: space-around; border-radius: 20px 20px 0 0; }
        .nav-btn { background: none; border: none; color: #666; font-size: 1.4rem; padding: 5px 15px; transition: 0.3s; }
        .nav-btn.active { color: #fff; transform: translateY(-5px); text-shadow: 0 0 10px var(--accent-glow); }

        /* Upgrade Ring */
        .roulette-wrapper { position: relative; width: 240px; height: 240px; margin: 10px auto; display: flex; align-items: center; justify-content: center; }
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-circle { stroke-dasharray: 628; stroke-dashoffset: 628; transition: stroke-dashoffset 0.5s; filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); }
        .static-center { position: absolute; width: 180px; height: 180px; background: #151517; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 2; overflow: hidden; }
        .roulette-marker { position: absolute; top: -5px; left: 50%; transform: translateX(-50%); width:0; height:0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 15px solid white; z-index: 5; }
        .u-slot { width: 100px; height: 130px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.65rem; color: #555; font-weight: 700; cursor: pointer; text-align: center; padding: 10px; }
        
        /* Modals */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 200; display:flex; align-items:center; justify-content:center; }
        .modal-content { background: #151517; padding: 30px 25px; border-radius: 30px; text-align: center; border: 1px solid rgba(255,255,255,0.08); width: 90%; max-width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
        .close-btn { width: 100%; background: transparent; border: none; color: #666; padding: 15px; cursor: pointer; margin-top: 5px; font-weight: 600; }
        
        /* Profile */
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; background: linear-gradient(145deg, #232328, #1e1e22); padding: 25px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.05); }
        .profile-avatar { width: 75px; height: 75px; background: #2a2a2a; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 35px; overflow: hidden; border: 2px solid var(--accent); flex-shrink: 0; }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .stat-card { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.02); }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--accent); display: block; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
    </style>
</head>
<body>
    <div id="loading-screen"><div class="spinner"></div></div>

    <header>
        <div class="logo">üß† BRAINROT <span>DROP</span></div>
        <div class="balance-badge">‚≠êÔ∏è <span id="balance">0</span></div>
    </header>

    <main>
        <section id="tab-cases" class="tab-content active"><div id="cases-grid" class="grid"></div></section>

        <section id="tab-upgrade" class="tab-content">
            <h2 style="text-align:center;margin-bottom:15px;color:var(--accent);">–ê–ü–ì–†–ï–ô–î</h2>
            <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
                <div id="u-slot-left" class="u-slot" onclick="openSelector('left')">–ü–†–ï–î–ú–ï–¢</div>
                <div style="font-size: 20px; align-self: center;">‚ûî</div>
                <div id="u-slot-right" class="u-slot" onclick="openSelector('right')">–¶–ï–õ–¨</div>
            </div>
            
            <div class="roulette-wrapper">
                <div class="roulette-marker"></div>
                <svg class="progress-ring" width="240" height="240">
                     <circle class="progress-ring-circle-bg" cx="120" cy="120" r="100" stroke="#1e1e22" stroke-width="20" fill="transparent"/>
                     <circle id="upgrade-circle-fg" class="progress-ring-circle" cx="120" cy="120" r="100" stroke="#FFD700" stroke-width="20" fill="transparent" stroke-dasharray="628" stroke-dashoffset="628"/>
                </svg>
                <div class="static-center">
                    <img src="https://i.ibb.co/rKS1f8X3/unnamed-1.jpg" class="center-logo">
                    <div class="center-content">
                        <div class="chance-text" id="u-chance">0%</div>
                        <span style="color:#aaa; font-size:0.8rem">–®–ê–ù–°</span>
                    </div>
                </div>
            </div>
            <button id="upgrade-btn" class="btn" disabled style="margin-top:20px;">–ü–†–û–ö–ê–ß–ê–¢–¨</button>
        </section>

        <section id="tab-games" class="tab-content">
            <button class="btn" onclick="openCreateGame()">+ –°–û–ó–î–ê–¢–¨ –ò–ì–†–£</button>
            <div id="games-list" style="margin-top:15px; display:flex; flex-direction:column; gap:10px;"></div>
            <div id="active-game-ui" class="hidden" style="text-align:center; margin-top:20px;">
                <h2 id="game-status">–û–∂–∏–¥–∞–Ω–∏–µ...</h2>
                <div id="game-controls" class="grid" style="grid-template-columns:1fr 1fr; margin-top:20px;"></div>
                <button class="close-btn" style="margin-top:20px" onclick="exitGame()">–í—ã–π—Ç–∏</button>
            </div>
        </section>

        <section id="tab-inventory" class="tab-content">
            <button class="btn" style="margin-bottom:15px; background:rgba(255,50,50,0.2); color:#ff5555" onclick="sellAll()">–ü–†–û–î–ê–¢–¨ –í–°–Å</button>
            <div id="inventory-grid" class="grid"></div>
        </section>

        <section id="tab-leaderboard" class="tab-content"><div id="lb-list"></div></section>

        <section id="tab-profile" class="tab-content">
            <button id="back-prof" class="hidden close-btn" style="text-align:left; color:var(--accent)" onclick="load()">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="profile-header">
                <div class="profile-avatar" id="prof-avatar">üë§</div>
                <div><h2 id="prof-name">User</h2><span style="color:#666;font-size:0.8rem;font-weight:600;">–ò–≥—Ä–æ–∫</span></div>
            </div>
            <div class="stat-grid">
                <div class="stat-card"><span class="stat-val" id="prof-balance">0</span><span class="stat-label">–ë–∞–ª–∞–Ω—Å</span></div>
                <div class="stat-card"><span class="stat-val" id="prof-networth">0</span><span class="stat-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ</span></div>
                <div class="stat-card"><span class="stat-val" id="prof-cases">0</span><span class="stat-label">–ö–µ–π—Å–æ–≤</span></div>
            </div>
            <h3 style="margin:20px 0 10px;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏–≥—Ä–æ–∫–∞:</h3>
            <div id="prof-inv" class="grid"></div>
        </section>
    </main>

    <nav class="nav">
        <button class="nav-btn active" onclick="tab('cases')">üì¶</button>
        <button class="nav-btn" onclick="tab('upgrade')">üìà</button>
        <button class="nav-btn" onclick="tab('games')">üéÆ</button>
        <button class="nav-btn" onclick="tab('inventory')">üéí</button>
        <button class="nav-btn" onclick="tab('leaderboard')">üèÜ</button>
        <button class="nav-btn" onclick="tab('profile')">üë§</button>
    </nav>

    <!-- MODALS -->
    <div id="modal-selector" class="modal hidden">
        <div class="modal-content" style="height:80vh; overflow-y:auto;">
            <h3>–í—ã–±–µ—Ä–∏ –ø—Ä–µ–¥–º–µ—Ç</h3>
            <div id="selector-grid" class="grid" style="margin-top:15px;"></div>
            <button class="close-btn" onclick="closeModal('modal-selector')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="modal-item" class="modal hidden">
        <div class="modal-content">
            <h3 id="det-name" style="color:var(--accent)">NAME</h3>
            <img id="det-img" style="width:120px; height:120px; object-fit:contain; margin:15px auto;">
            <div class="info-row"><span>–†–µ–¥–∫–æ—Å—Ç—å:</span><span id="det-rarity" style="font-weight:bold"></span></div>
            <div class="info-row"><span>–¶–µ–Ω–∞:</span><span id="det-price" style="font-weight:bold"></span></div>
            <div id="det-muts" style="text-align:left; margin-top:10px;"></div>
            <button class="btn" id="btn-sell-one" style="margin-top:20px;">–ü–†–û–î–ê–¢–¨</button>
            <button class="close-btn" onclick="closeModal('modal-item')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="modal-create-game" class="modal hidden">
        <div class="modal-content">
            <h3>–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</h3>
            <div style="display:flex; gap:10px; margin:15px 0;">
                <button class="btn" onclick="gameType='rps'">‚úÇÔ∏è –ö–ù–ë</button>
                <button class="btn" onclick="gameType='even_odd'">üé≤ –ß/–ù</button>
            </div>
            <input type="number" id="wager-val" placeholder="–°—É–º–º–∞" style="width:100%; padding:12px; background:#111; border:1px solid #333; color:white; border-radius:10px;">
            <div id="wager-item-block" style="margin:15px 0; padding:10px; border:1px dashed #444; border-radius:10px; cursor:pointer;" onclick="openSelector('wager')">
                <span id="wager-item-name" style="color:#aaa">–í—ã–±—Ä–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç (–∏–ª–∏ –¥–µ–Ω—å–≥–∏)</span>
            </div>
            <button class="btn" onclick="doCreateGame()">–°–û–ó–î–ê–¢–¨</button>
            <button class="close-btn" onclick="closeModal('modal-create-game')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const API = '/api';
        const tg = window.Telegram.WebApp;
        let userId = tg.initDataUnsafe?.user?.id || 0;
        let inventory = [], allItems = [], upgLeft=null, upgRight=null, selMode='', wagerItem=null, gameType='rps';
        let activeGameId = null;

        const MUTS = {'Gold':'#FFD700','Diamond':'#b9f2ff','Bloodrot':'#ff3333','Candy':'#ff69b4','Rainbow':'#cc33ff','Galaxy':'#9933ff'};
        const EMOJIS = {'Gold':'ü•á','Diamond':'üíé','Bloodrot':'ü©∏','Candy':'üç¨','Rainbow':'üåà','Galaxy':'üåå'};

        function el(id) { return document.getElementById(id); }
        function closeModal(id) { el(id).classList.add('hidden'); }
        function tab(t) { 
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
            el('tab-'+t).classList.add('active');
            if(t!=='profile') el('back-prof').classList.add('hidden');
        }
        function formatBalance(n) { return n >= 1000000 ? (n/1000000).toFixed(1)+'M' : (n >= 1000 ? (n/1000).toFixed(1)+'k' : n); }

        async function req(ep, body={}) {
            body.user_id = userId;
            try {
                const r = await fetch(API+ep, {method:'POST', body:JSON.stringify(body)});
                return await r.json();
            } catch(e) { console.error(e); return {}; }
        }

        async function load() {
            const d = await req('/data', {username: tg.initDataUnsafe?.user?.username, photo_url: tg.initDataUnsafe?.user?.photo_url});
            if(!d.user) return; // Error safety
            
            el('balance').innerText = formatBalance(d.user.balance);
            inventory = d.inventory;
            allItems = d.all_items;

            renderItems('cases-grid', d.cases, 'case');
            renderItems('inventory-grid', inventory, 'inv');
            
            // Profile
            el('prof-name').innerText = d.user.username;
            el('prof-balance').innerText = formatBalance(d.user.balance);
            el('prof-networth').innerText = formatBalance(d.user.net_worth);
            el('prof-cases').innerText = d.user.cases_opened;
            if(d.user.photo_url) el('prof-avatar').innerHTML = `<img src="${d.user.photo_url}">`;
            el('prof-inv').innerHTML = ''; // Reset foreign view

            // Leaderboard
            el('lb-list').innerHTML = d.leaderboard.map((u,i)=>`
                <div class="leaderboard-item" onclick="viewUser(${u.tg_id})">
                    <div style="display:flex;align-items:center;gap:10px">
                        <span class="lb-rank">#${i+1}</span>
                        <img src="${u.photo_url}" class="lb-avatar" onerror="this.style.display='none'">
                        ${u.username}
                    </div>
                    <span style="color:#FFD700">${formatBalance(u.net_worth)}</span>
                </div>
            `).join('');

            updateGames();
            el('loading-screen').classList.add('hidden');
        }

        function renderItems(containerId, items, mode) {
            const con = el(containerId); con.innerHTML = '';
            if(!items.length) { con.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#666">–ü—É—Å—Ç–æ</div>'; return; }
            
            items.forEach(i => {
                const div = document.createElement('div');
                div.className = `card rarity-${i.rarity}`;
                
                let mutHtml = '';
                if(i.muts_list && i.muts_list.length) {
                    div.classList.add('mutated');
                    div.style.setProperty('--glow-color', MUTS[i.muts_list[0]] || '#fff');
                    mutHtml = `<span class="mut-badge">${i.muts_list.map(m=>EMOJIS[m]||'‚ú®').join('')}</span>`;
                }

                div.innerHTML = `
                    ${mutHtml}
                    <img src="${i.image_url||i.icon_url}">
                    <div class="card-name">${i.name}</div>
                    <div class="card-price">${formatBalance(i.price)}‚≠êÔ∏è</div>
                    ${i.quantity > 1 ? `<div class="qty-badge">x${i.quantity}</div>` : ''}
                    ${mode==='inv' ? `<button class="sell-btn">–ü–†–û–î–ê–¢–¨</button>` : ''}
                `;
                
                div.onclick = (e) => {
                    if (e.target.classList.contains('sell-btn')) { openSellOne(i); return; }
                    if (mode === 'case') openCase(i.id);
                    else if (mode === 'inv') showDetails(i);
                    else if (mode === 'sel') selectItem(i);
                };
                con.appendChild(div);
            });
        }

        // --- ACTIONS ---
        async function openCase(cid) {
            const r = await req('/open', {case_id: cid, count: 1});
            if(r.dropped) { alert(`–í—ã–ø–∞–ª–æ: ${r.dropped[0].name}`); load(); }
            else alert(r.error);
        }

        function showDetails(i) {
            el('modal-item').classList.remove('hidden');
            el('det-name').innerText = i.name;
            el('det-img').src = i.image_url;
            el('det-rarity').innerText = i.rarity;
            el('det-price').innerText = formatBalance(i.price);
            el('det-muts').innerHTML = i.muts_list ? i.muts_list.map(m=>`<div class="info-row"><span style="color:${MUTS[m]}">${m}</span></div>`).join('') : '–ù–µ—Ç';
            el('btn-sell-one').onclick = () => openSellOne(i);
        }

        async function openSellOne(i) {
            await req('/sell_batch', {item_id: i.item_id, count:1, mutations: i.muts_list});
            closeModal('modal-item'); load();
        }

        async function sellAll() {
            if(confirm('–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë?')) { await req('/sell_all'); load(); }
        }

        async function viewUser(tid) {
            if(tid == userId) { tab('profile'); return; }
            const d = await req('/profile', {target_id: tid});
            if(d.error) return;
            const p = d.profile;
            tab('profile');
            el('back-prof').classList.remove('hidden');
            el('prof-name').innerText = p.username;
            el('prof-balance').innerText = formatBalance(p.balance);
            el('prof-networth').innerText = formatBalance(p.net_worth);
            el('prof-cases').innerText = p.cases_opened;
            if(p.photo_url) el('prof-avatar').innerHTML = `<img src="${p.photo_url}">`;
            renderItems('prof-inv', p.inventory || [], 'view');
        }

        // --- SELECTOR & UPGRADE ---
        function openSelector(mode) {
            selMode = mode;
            el('modal-selector').classList.remove('hidden');
            let list = (mode==='left' || mode==='wager') ? inventory.filter(x=>x.quantity>0) : allItems;
            if(mode==='right' && upgLeft) { 
                // Filter: items better than current
                // Simplified: All items are available targets
            }
            renderItems('selector-grid', list, 'sel');
        }

        function selectItem(i) {
            closeModal('modal-selector');
            if(selMode === 'left') {
                upgLeft = i; 
                el('u-slot-left').innerHTML = `<img src="${i.image_url}" style="width:70px">`;
                el('u-slot-left').classList.add('rarity-'+i.rarity);
            } else if(selMode === 'right') {
                upgRight = i;
                el('u-slot-right').innerHTML = `<img src="${i.image_url}" style="width:70px">`;
                el('u-slot-right').classList.add('rarity-'+i.rarity);
            } else if(selMode === 'wager') {
                wagerItem = i;
                el('wager-item-name').innerText = i.name;
                el('wager-val').value = '';
            }
            if(upgLeft && upgRight) {
                let ch = (upgLeft.sell_price / upgRight.price) * 100 * 0.95;
                if(ch>80) ch=80; if(ch<1) ch=1;
                el('u-chance').innerText = ch.toFixed(1) + '%';
                el('upgrade-btn').disabled = false;
                el('upgrade-circle-fg').style.strokeDashoffset = 628 - (ch/100)*628;
            }
        }

        el('upgrade-btn').onclick = async () => {
            el('upgrade-btn').disabled = true;
            const res = await req('/upgrade', {item_id: upgLeft.item_id, target_id: upgRight.id});
            alert(res.status === 'win' ? '–£–°–ü–ï–•!' : '–ù–ï–£–î–ê–ß–ê');
            load();
            upgLeft=null; upgRight=null;
            el('u-slot-left').innerHTML = '–ü–†–ï–î–ú–ï–¢'; el('u-slot-right').innerHTML = '–¶–ï–õ–¨';
            el('u-chance').innerText = '0%';
        };

        // --- GAMES ---
        function openCreateGame() { el('modal-create-game').classList.remove('hidden'); wagerItem=null; el('wager-item-name').innerText='–í—ã–±—Ä–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç'; }
        
        async function doCreateGame() {
            const amt = parseInt(el('wager-val').value) || 0;
            const type = wagerItem ? 'item' : 'balance';
            const res = await req('/games/create', {game_type: gameType, wager_type: type, wager_amount: amt, wager_item_id: wagerItem?.item_id});
            if(res.status=='ok') { closeModal('modal-create-game'); updateGames(); }
            else alert(res.error);
        }

        async function updateGames() {
            if(activeGameId) { pollStatus(); return; }
            const d = await req('/games/list');
            el('games-list').innerHTML = d.games.map(g => `
                <div class="card" style="aspect-ratio:auto; flex-direction:row; padding:15px; justify-content:space-between; margin-bottom:0;">
                    <div style="text-align:left">
                        <div style="font-weight:700">${g.host_name}</div>
                        <small style="color:#888">${g.game_type === 'rps' ? '–ö–ù–ë' : '–ß–µ—Ç/–ù–µ—á–µ—Ç'}</small>
                        <div style="color:var(--accent)">${g.wager_type==='balance' ? g.wager_amount+'‚≠êÔ∏è' : g.item_name}</div>
                    </div>
                    <button class="btn" style="width:auto; padding:8px 20px" onclick="joinGame(${g.id})">–ò–ì–†–ê–¢–¨</button>
                </div>
            `).join('') || '<div style="text-align:center; color:#555">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä</div>';
            
            // Check if I have active game
            pollStatus();
        }

        async function joinGame(gid) {
            const r = await req('/games/join', {game_id: gid});
            if(r.status=='ok') { activeGameId=gid; pollStatus(); }
            else alert(r.error);
        }

        async function pollStatus() {
            const st = await req('/games/status');
            if(st.game) {
                activeGameId = st.game.id;
                renderGameUI(st.game);
            } else {
                activeGameId = null;
                el('active-game-ui').classList.add('hidden');
                el('games-lobby').classList.remove('hidden'); // Ensure lobby is visible
            }
        }

        function renderGameUI(g) {
            el('games-lobby').classList.add('hidden');
            el('active-game-ui').classList.remove('hidden');
            
            const isHost = (g.host_tg_id === userId);
            el('game-status').innerText = (g.status === 'playing') ? '–í–ê–® –•–û–î!' : '–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...';
            
            // Controls
            if(g.status === 'playing') {
                if((isHost && !g.host_move) || (!isHost && !g.guest_move)) {
                    let opts = g.game_type === 'rps' ? ['rock','paper','scissors'] : (isHost ? ['1','2'] : ['odd','even']);
                    el('game-controls').innerHTML = opts.map(o => 
                        `<button class="btn" onclick="makeMove(${g.id}, '${o}')">${o}</button>`
                    ).join('');
                } else {
                    el('game-controls').innerHTML = '<div style="grid-column:1/-1">–ñ–¥–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</div>';
                }
            } else if (g.status === 'finished') {
                const won = (g.winner_id === 0) ? '–ù–ò–ß–¨–Ø' : ( (isHost && g.winner_id === g.host_id) || (!isHost && g.winner_id === g.guest_id) ? '–ü–û–ë–ï–î–ê!' : '–ü–û–†–ê–ñ–ï–ù–ò–ï' );
                el('game-status').innerText = won;
                el('game-controls').innerHTML = '';
            }
        }

        async function makeMove(gid, m) { await req('/games/move', {game_id: gid, move: m}); pollStatus(); }
        async function exitGame() { 
            if(activeGameId) await req('/games/cancel', {game_id: activeGameId});
            activeGameId = null; 
            el('active-game-ui').classList.add('hidden');
            el('games-lobby').classList.remove('hidden');
            load();
        }

        load();
        setInterval(() => { if(activeGameId || !el('games-lobby').classList.contains('hidden')) updateGames(); }, 3000);

    </script>
</body>
</html>