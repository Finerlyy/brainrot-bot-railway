<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brainrot Drop v3</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #121214; --card: #1e1e22; --accent: #FFD700; --brc-color: #ff33ff; }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { background: var(--bg); color: #fff; font-family: 'Montserrat', sans-serif; padding-bottom: 90px; }
        .hidden { display: none !important; }
        
        /* Rarity Colors */
        .rarity-Common { border-color: #666; box-shadow: 0 0 5px rgba(100,100,100,0.2); }
        .rarity-Uncommon { border-color: #5e98d9; box-shadow: 0 0 5px rgba(94,152,217,0.2); }
        .rarity-Rare { border-color: #4b69ff; box-shadow: 0 0 8px rgba(75,105,255,0.3); }
        .rarity-Mythical { border-color: #d32ce6; box-shadow: 0 0 10px rgba(211,44,230,0.4); }
        .rarity-Legendary { border-color: #ff9900; box-shadow: 0 0 12px rgba(255,153,0,0.5); }
        .rarity-Immortal { border-color: #00ffff; box-shadow: 0 0 15px rgba(0,255,255,0.6); }
        .rarity-Secret { border-color: #ff0000; box-shadow: 0 0 20px rgba(255,0,0,0.7); }

        /* Animation */
        @keyframes neonPulse { 50% { box-shadow: 0 0 15px var(--glow-color), inset 0 0 5px var(--glow-color); border-color: #fff; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* UI Elements */
        .loader { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 999; display:flex; justify-content:center; align-items:center; }
        .spinner { width:40px; height:40px; border:4px solid #333; border-top:4px solid var(--accent); border-radius:50%; animation: spin 1s linear infinite; }
        
        header { display: flex; justify-content: space-between; padding: 15px; background: rgba(30,30,35,0.9); position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: 900; } .logo span { color: var(--accent); }
        .badges { display: flex; gap: 10px; }
        .badge { background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 700; display:flex; align-items:center; gap:5px; }
        
        .tab-content { display: none; padding: 15px; }
        .tab-content.active { display: block; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(95px, 1fr)); gap: 10px; }
        
        /* Item Card (Squared) */
        .card { 
            background: var(--card); border: 2px solid rgba(255,255,255,0.1); border-radius: 16px; 
            aspect-ratio: 1/1; position: relative; overflow: hidden; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .card:active { transform: scale(0.96); }
        .card img { width: 75%; height: 75%; object-fit: contain; border-radius: 12px; margin-bottom: 5px; }
        .card-name { font-size: 0.7rem; font-weight: 700; max-width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-price { font-size: 0.65rem; color: #888; }
        
        .mutated { animation: neonPulse 2s infinite; border-color: var(--glow-color) !important; }
        .mut-badge { position: absolute; top:5px; left:5px; font-size:0.8rem; }
        .qty-badge { position: absolute; bottom:5px; right:5px; background:rgba(0,0,0,0.7); font-size:0.7rem; padding:2px 5px; border-radius:5px; }

        /* Buttons */
        .btn { width: 100%; background: linear-gradient(135deg, #FFD700, #FDB931); border: none; padding: 12px; border-radius: 12px; font-weight: 800; color: #000; margin-top: 10px; cursor: pointer; }
        .btn:disabled { opacity: 0.5; }
        .nav { position: fixed; bottom: 0; width: 100%; background: #1a1a1a; display: flex; justify-content: space-around; padding: 10px; border-top: 1px solid #333; z-index: 90; }
        .nav-btn { background: none; border: none; color: #666; font-size: 1.2rem; }
        .nav-btn.active { color: var(--accent); transform: scale(1.1); }

        /* Modal */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 200; display:flex; align-items:center; justify-content:center; }
        .modal-box { background: #151515; width: 90%; max-width: 350px; padding: 20px; border-radius: 20px; text-align: center; border: 1px solid #333; }
        .close { float: right; font-size: 1.5rem; cursor: pointer; color: #666; }
        
        /* Stats */
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #222; font-size: 0.9rem; }
        .stat-val { color: #fff; font-weight: bold; }
        
        /* Leaderboard */
        .lb-item { display: flex; justify-content: space-between; padding: 15px; background: var(--card); margin-bottom: 8px; border-radius: 12px; align-items: center; }
        .lb-rank { font-weight: 900; width: 30px; }
    </style>
</head>
<body>
    <div id="loading-screen" class="loader"><div class="spinner"></div></div>

    <header>
        <div class="logo">üß† DROP</div>
        <div class="badges">
            <div class="badge" style="color:var(--accent)">‚≠êÔ∏è <span id="bal">0</span></div>
            <div class="badge" style="color:var(--brc-color)">üß¨ <span id="brc">0</span></div>
        </div>
    </header>

    <main>
        <!-- CASES -->
        <section id="tab-cases" class="tab-content active">
            <div id="cases-grid" class="grid"></div>
        </section>

        <!-- INCUBATOR -->
        <section id="tab-incubator" class="tab-content" style="text-align:center">
            <h2 style="color:var(--brc-color); margin-bottom:20px;">–ò–ù–ö–£–ë–ê–¢–û–†</h2>
            <div style="width:150px; height:220px; border:2px solid #333; border-radius:50px; margin:0 auto; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;" id="inc-capsule">
                <div id="inc-content" style="z-index:2">–ü—É—Å—Ç–æ</div>
                <div id="inc-liquid" style="position:absolute; bottom:0; width:100%; height:0%; background:rgba(255,51,255,0.3); transition:1s;"></div>
            </div>
            <div style="margin-top:20px">
                <h3 id="inc-speed">0 / –¥–µ–Ω—å</h3>
                <button class="btn" id="inc-btn" onclick="openSelector('incubator')">–ü–æ–ª–æ–∂–∏—Ç—å</button>
                <div id="inc-actions" class="hidden" style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn" style="background:#ff33ff; color:white" onclick="claimInc()">–°–æ–±—Ä–∞—Ç—å</button>
                    <button class="btn" style="background:#333; color:white; border:1px solid #555" onclick="takeInc()">–ó–∞–±—Ä–∞—Ç—å</button>
                </div>
            </div>
        </section>

        <!-- UPGRADE -->
        <section id="tab-upgrade" class="tab-content" style="text-align:center">
            <div style="display:flex; justify-content:center; gap:20px; align-items:center; margin-bottom:20px;">
                <div id="u-slot-left" class="card" style="width:100px; height:100px;" onclick="openSelector('left')">–ü—Ä–µ–¥–º–µ—Ç</div>
                <div style="font-size:20px">‚ûî</div>
                <div id="u-slot-right" class="card" style="width:100px; height:100px;" onclick="openSelector('right')">–¶–µ–ª—å</div>
            </div>
            <h1 id="u-chance">0%</h1>
            <button class="btn" id="u-btn" disabled onclick="doUpgrade()">–ü–†–û–ö–ê–ß–ê–¢–¨</button>
        </section>

        <!-- GAMES -->
        <section id="tab-games" class="tab-content">
            <button class="btn" onclick="openCreateGame()">+ –°–û–ó–î–ê–¢–¨ –ò–ì–†–£</button>
            <div id="games-list" style="margin-top:15px; display:flex; flex-direction:column; gap:10px;"></div>
            <!-- Active Game UI hidden by default -->
            <div id="game-ui" class="hidden" style="text-align:center; margin-top:20px;">
                <h2 id="game-status">–ò–≥—Ä–∞...</h2>
                <div id="game-controls" class="grid" style="grid-template-columns:1fr 1fr; margin-top:20px;"></div>
            </div>
        </section>

        <!-- INVENTORY -->
        <section id="tab-inventory" class="tab-content">
            <button class="btn" style="margin-bottom:15px; background:#333; color:white; border:1px solid #555" onclick="sellAll()">–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë</button>
            <div id="inventory-grid" class="grid"></div>
        </section>

        <!-- PROFILE -->
        <section id="tab-profile" class="tab-content">
            <button id="back-prof" class="hidden btn" style="background:none; text-align:left; color:#888" onclick="load()">‚Üê –ù–∞–∑–∞–¥</button>
            <div style="background:#1e1e22; padding:20px; border-radius:20px; display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                <img id="prof-img" style="width:60px; height:60px; border-radius:50%; background:#333;">
                <div><h2 id="prof-name">User</h2><span style="color:#aaa">–ò–≥—Ä–æ–∫</span></div>
            </div>
            <div class="stat-row"><span>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</span><span class="stat-val" id="prof-net">0</span></div>
            <div class="stat-row"><span>–ö–µ–π—Å–æ–≤:</span><span class="stat-val" id="prof-cases">0</span></div>
            <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏–≥—Ä–æ–∫–∞:</h3>
            <div id="prof-inv" class="grid" style="margin-top:10px;"></div>
        </section>

        <!-- LEADERBOARD -->
        <section id="tab-leaderboard" class="tab-content">
            <div id="lb-list"></div>
        </section>
    </main>

    <nav class="nav">
        <button class="nav-btn active" onclick="tab('cases')">üì¶</button>
        <button class="nav-btn" onclick="tab('incubator')">üß™</button>
        <button class="nav-btn" onclick="tab('upgrade')">üìà</button>
        <button class="nav-btn" onclick="tab('games')">üéÆ</button>
        <button class="nav-btn" onclick="tab('inventory')">üéí</button>
        <button class="nav-btn" onclick="tab('leaderboard')">üèÜ</button>
        <button class="nav-btn" onclick="tab('profile')">üë§</button>
    </nav>

    <!-- Modals -->
    <div id="modal-selector" class="modal hidden">
        <div class="modal-box" style="max-width:100%; height:80vh; overflow-y:auto;">
            <span class="close" onclick="closeModal('modal-selector')">&times;</span>
            <h3>–í—ã–±–µ—Ä–∏ –ø—Ä–µ–¥–º–µ—Ç</h3>
            <div id="selector-grid" class="grid" style="margin-top:15px;"></div>
        </div>
    </div>

    <div id="modal-item" class="modal hidden">
        <div class="modal-box">
            <span class="close" onclick="closeModal('modal-item')">&times;</span>
            <h3 id="det-name" style="color:var(--accent)">Name</h3>
            <img id="det-img" style="width:100px; margin:10px auto; display:block;">
            <div class="stat-row"><span>–†–µ–¥–∫–æ—Å—Ç—å:</span><span id="det-rarity" class="stat-val"></span></div>
            <div class="stat-row"><span>–¶–µ–Ω–∞:</span><span id="det-price" class="stat-val"></span></div>
            <div id="det-muts" style="text-align:left; margin-top:10px; color:#aaa; font-size:0.8rem;"></div>
            <button class="btn" id="btn-sell-one">–ü—Ä–æ–¥–∞—Ç—å</button>
        </div>
    </div>

    <div id="modal-create-game" class="modal hidden">
        <div class="modal-box">
            <span class="close" onclick="closeModal('modal-create-game')">&times;</span>
            <h3>–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</h3>
            <div style="display:flex; gap:10px; margin:10px 0;">
                <button class="btn" onclick="gameType='rps'">‚úÇÔ∏è –ö–ù–ë</button>
                <button class="btn" onclick="gameType='even_odd'">üé≤ –ß/–ù</button>
            </div>
            <input type="number" id="wager-val" placeholder="–°—É–º–º–∞" style="width:100%; padding:10px; margin-bottom:10px;">
            <button class="btn" style="background:#333; color:white" onclick="openSelector('wager')">–ò–ª–∏ –ø—Ä–µ–¥–º–µ—Ç</button>
            <div id="wager-item-name" style="color:#aaa; font-size:0.8rem; margin:5px 0;"></div>
            <button class="btn" onclick="doCreateGame()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const API = '/api';
        const tg = window.Telegram.WebApp;
        let userId = tg.initDataUnsafe?.user?.id || 0;
        // userId = 12345; // Uncomment for testing in browser without TG
        
        let inventory = [], allItems = [];
        let curMode = '', upgLeft=null, upgRight=null, wagerItem=null, gameType='rps';
        
        const COLORS = {'Common':'#666', 'Uncommon':'#5e98d9', 'Rare':'#4b69ff', 'Mythical':'#d32ce6', 'Legendary':'#ff9900', 'Immortal':'#00ffff', 'Secret':'#ff0000'};
        const MUTS = {'Gold':'#FFD700','Diamond':'#b9f2ff','Bloodrot':'#ff3333','Candy':'#ff69b4','Rainbow':'#cc33ff','Galaxy':'#9933ff'};

        function el(id) { return document.getElementById(id); }
        function closeModal(id) { el(id).classList.add('hidden'); }
        function tab(t) { 
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            el('tab-'+t).classList.add('active');
            if(t!=='profile') el('back-prof').classList.add('hidden');
        }

        async function req(ep, body={}) {
            body.user_id = userId;
            const r = await fetch(API+ep, {method:'POST', body:JSON.stringify(body)});
            return r.json();
        }

        async function load() {
            try {
                const d = await req('/data', {username: tg.initDataUnsafe?.user?.username, photo_url: tg.initDataUnsafe?.user?.photo_url});
                el('bal').innerText = d.user.balance;
                el('brc').innerText = d.user.brainrot_coins;
                
                inventory = d.inventory;
                allItems = d.all_items;
                
                renderGrid('cases-grid', d.cases, 'case');
                renderGrid('inventory-grid', inventory, 'inv');
                
                // Profile
                el('prof-name').innerText = d.user.username;
                el('prof-img').src = d.user.photo_url;
                el('prof-net').innerText = d.user.net_worth;
                el('prof-cases').innerText = d.user.cases_opened;
                el('prof-inv').innerHTML = ''; // Clear other user view
                
                // Leaderboard
                el('lb-list').innerHTML = d.leaderboard.map((u,i)=>`
                    <div class="lb-item" onclick="viewUser(${u.tg_id})">
                        <div style="display:flex;align-items:center;gap:10px">
                            <span class="lb-rank">#${i+1}</span>
                            <img src="${u.photo_url||''}" style="width:30px;height:30px;border-radius:50%;background:#333">
                            ${u.username}
                        </div>
                        <span style="color:#FFD700">${u.net_worth}</span>
                    </div>`).join('');

                updateInc(d.incubator);
                updateGames();
                
                el('loading-screen').classList.add('hidden');
            } catch(e) { console.error(e); el('loading-screen').classList.add('hidden'); }
        }

        // --- RENDERERS ---
        function renderGrid(id, items, type) {
            const con = el(id); con.innerHTML = '';
            if(!items.length) { con.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#666">–ü—É—Å—Ç–æ</div>'; return; }
            
            items.forEach(i => {
                const div = document.createElement('div');
                const rarityColor = COLORS[i.rarity] || '#333';
                div.className = `card rarity-${i.rarity}`;
                div.style.borderColor = rarityColor;
                
                let mutHtml = '';
                if(i.muts_list && i.muts_list.length) {
                    div.classList.add('mutated');
                    div.style.setProperty('--glow-color', MUTS[i.muts_list[0]] || '#fff');
                    mutHtml = `<span class="mut-badge">‚ú®</span>`;
                }

                div.innerHTML = `
                    ${mutHtml}
                    <img src="${i.image_url||i.icon_url}">
                    <div class="card-name">${i.name}</div>
                    <div class="card-price">${i.price}‚≠êÔ∏è</div>
                    ${i.quantity > 1 ? `<div class="qty-badge">x${i.quantity}</div>` : ''}
                `;
                
                div.onclick = () => {
                    if(type === 'case') { /* Open Case Logic (simplified) */ openCase(i.id); }
                    else if(type === 'inv') { showItemDetails(i); }
                    else if(type === 'sel') { selectItem(i); }
                };
                con.appendChild(div);
            });
        }

        function showItemDetails(i) {
            el('modal-item').classList.remove('hidden');
            el('det-name').innerText = i.name;
            el('det-img').src = i.image_url;
            el('det-rarity').innerText = i.rarity;
            el('det-rarity').style.color = COLORS[i.rarity];
            el('det-price').innerText = i.price;
            
            el('det-muts').innerHTML = i.muts_list ? i.muts_list.join(', ') : '–ù–µ—Ç –º—É—Ç–∞—Ü–∏–π';
            
            el('btn-sell-one').onclick = async () => {
                await req('/sell_batch', {item_id: i.item_id, count:1, mutations: i.muts_list});
                closeModal('modal-item'); load();
            };
        }

        async function viewUser(tid) {
            const d = await req('/profile', {target_id: tid});
            if(d.error) return;
            const p = d.profile;
            tab('profile');
            el('back-prof').classList.remove('hidden');
            el('prof-name').innerText = p.username;
            el('prof-img').src = p.photo_url;
            el('prof-net').innerText = p.net_worth;
            el('prof-cases').innerText = p.cases_opened;
            renderGrid('prof-inv', p.inventory || [], 'none'); // View only
        }

        // --- LOGIC ---
        
        async function openCase(cid) {
            const res = await req('/open', {case_id: cid, count: 1});
            if(res.dropped) { alert(`–í—ã–ø–∞–ª–æ: ${res.dropped[0].name}`); load(); }
            else alert(res.error);
        }

        function openSelector(mode) {
            curMode = mode;
            el('modal-selector').classList.remove('hidden');
            let list = (mode==='incubator' || mode==='left' || mode==='wager') ? inventory.filter(x=>x.quantity>0) : allItems;
            renderGrid('selector-grid', list, 'sel');
        }

        function selectItem(i) {
            closeModal('modal-selector');
            if(curMode === 'incubator') {
                req('/incubator/put', {item_id: i.item_id, mutations: i.muts_list}).then(load);
            } else if(curMode === 'left') {
                upgLeft = i; el('u-slot-left').innerHTML = `<img src="${i.image_url}" style="width:60px">`;
                calcChance();
            } else if(curMode === 'right') {
                upgRight = i; el('u-slot-right').innerHTML = `<img src="${i.image_url}" style="width:60px">`;
                calcChance();
            } else if(curMode === 'wager') {
                wagerItem = i; el('wager-item-name').innerText = i.name;
            }
        }

        // Upgrade
        function calcChance() {
            if(upgLeft && upgRight) {
                let ch = (upgLeft.sell_price / upgRight.price) * 100 * 0.95;
                if(ch>80) ch=80; if(ch<1) ch=1;
                el('u-chance').innerText = ch.toFixed(1) + '%';
                el('u-btn').disabled = false;
            }
        }
        async function doUpgrade() {
            el('u-btn').disabled = true;
            const res = await req('/upgrade', {item_id: upgLeft.item_id, target_id: upgRight.id});
            alert(res.status === 'win' ? '–£–°–ü–ï–•!' : '–ù–ï–£–î–ê–ß–ê');
            upgLeft=null; upgRight=null; el('u-slot-left').innerText='–ü—Ä–µ–¥–º–µ—Ç'; el('u-slot-right').innerText='–¶–µ–ª—å';
            load();
        }

        // Incubator
        function updateInc(inc) {
            if(inc) {
                el('inc-capsule').style.borderColor = '#ff33ff';
                el('inc-content').innerHTML = `<img src="${inc.image_url}" style="width:100px">`;
                el('inc-liquid').style.height = '100%';
                el('inc-btn').classList.add('hidden');
                el('inc-actions').classList.remove('hidden');
            } else {
                el('inc-capsule').style.borderColor = '#333';
                el('inc-content').innerText = '–ü—É—Å—Ç–æ';
                el('inc-liquid').style.height = '0%';
                el('inc-btn').classList.remove('hidden');
                el('inc-actions').classList.add('hidden');
            }
        }
        async function claimInc() { const r = await req('/incubator/claim'); if(r.added) alert(`+${r.added}`); load(); }
        async function takeInc() { await req('/incubator/take'); load(); }

        // Games
        function openCreateGame() { el('modal-create-game').classList.remove('hidden'); wagerItem=null; }
        async function doCreateGame() {
            const amt = parseInt(el('wager-val').value) || 0;
            const type = wagerItem ? 'item' : 'balance';
            await req('/games/create', {game_type: gameType, wager_type: type, wager_amount: amt, wager_item_id: wagerItem?.item_id});
            closeModal('modal-create-game'); updateGames();
        }
        async function updateGames() {
            const d = await req('/games/list');
            el('games-list').innerHTML = d.games.map(g => `
                <div class="card" style="aspect-ratio:auto; flex-direction:row; padding:15px; justify-content:space-between">
                    <div><b>${g.host_name}</b> <small>${g.game_type}</small></div>
                    <button class="btn" style="width:auto; margin:0" onclick="joinGame(${g.id})">–ò–≥—Ä–∞—Ç—å</button>
                </div>
            `).join('') || '<div style="text-align:center; color:#555">–ù–µ—Ç –∏–≥—Ä</div>';
            
            // Check active game (simplified poll)
            const st = await req('/games/status');
            if(st.game) renderGame(st.game); else el('game-ui').classList.add('hidden');
        }
        async function joinGame(gid) { await req('/games/join', {game_id: gid}); updateGames(); }
        
        function renderGame(g) {
            el('game-ui').classList.remove('hidden');
            el('game-status').innerText = g.status === 'playing' ? '–í–∞—à —Ö–æ–¥...' : '–û–∂–∏–¥–∞–Ω–∏–µ...';
            // Simple controls
            if(g.status === 'playing') {
                const isHost = (g.host_tg_id === userId);
                if ((isHost && !g.host_move) || (!isHost && !g.guest_move)) {
                    const opts = g.game_type === 'rps' ? ['rock','paper','scissors'] : (isHost?['1','2']:['odd','even']);
                    el('game-controls').innerHTML = opts.map(o => `<button class="btn" onclick="move(${g.id}, '${o}')">${o}</button>`).join('');
                } else {
                    el('game-controls').innerHTML = '–ñ–¥–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...';
                }
            }
        }
        async function move(gid, m) { await req('/games/move', {game_id: gid, move: m}); updateGames(); }

        async function sellAll() {
            if(confirm('–¢–æ—á–Ω–æ –ø—Ä–æ–¥–∞—Ç—å –≤—Å—ë?')) { await req('/sell_all'); load(); }
        }

        load();
        setInterval(() => { if(!el('game-ui').classList.contains('hidden')) updateGames(); }, 3000);

    </script>
</body>
</html>