<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brainrot Drop</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- CSS STYLES --- */
        :root { 
            --bg: #121214; 
            --card: #1e1e22; 
            --accent: #FFD700; 
            --accent-glow: rgba(255, 215, 0, 0.3);
            --star-gradient: linear-gradient(135deg, #FFD700, #FDB931); 
            --nav-bg: rgba(30, 30, 35, 0.85); 
            --text-muted: #8a8a93;
            --brc-color: #ff33ff; /* Brainrot Coin Color */
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; font-family: 'Montserrat', sans-serif; padding-bottom: 90px; overflow-x: hidden; }
        
        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        
        /* --- –ê–ù–ò–ú–ê–¶–ò–ò --- */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes smoothZoom { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes popItem { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes neonPulse {
            0% { box-shadow: 0 0 5px var(--glow-color), inset 0 0 5px var(--glow-color); border-color: var(--glow-color); }
            50% { box-shadow: 0 0 20px var(--glow-color), inset 0 0 10px var(--glow-color); border-color: #fff; }
            100% { box-shadow: 0 0 5px var(--glow-color), inset 0 0 5px var(--glow-color); border-color: var(--glow-color); }
        }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        /* Loader */
        #loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { width: 45px; height: 45px; border: 4px solid rgba(255,255,255,0.05); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 0.8s ease-in-out infinite; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(18, 18, 20, 0.9); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .logo { font-weight: 900; color: #fff; font-size: 1.1rem; letter-spacing: -0.5px; } .logo span { color: var(--accent); }
        .currencies { display: flex; gap: 10px; }
        .balance-badge { background: rgba(255, 215, 0, 0.1); color: #FFD700; font-weight: 700; border: 1px solid rgba(255, 215, 0, 0.2); padding: 6px 14px; border-radius: 20px; display: flex; align-items: center; gap: 6px; font-size: 0.8rem; }
        .brc-badge { background: rgba(255, 51, 255, 0.1); color: var(--brc-color); border-color: rgba(255, 51, 255, 0.3); }

        /* Tabs */
        .tab-content { display: none; padding: 15px; animation: smoothZoom 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .tab-content.active { display: block; }

        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--nav-bg); backdrop-filter: blur(20px); display: flex; padding: 10px 0 20px 0; border-top: 1px solid rgba(255,255,255,0.05); z-index: 50; justify-content: space-around; border-radius: 20px 20px 0 0; }
        .nav-btn { background: none; border: none; color: #666; font-weight: 600; padding: 5px; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.6rem; gap: 4px; min-width: 50px; position: relative; }
        .nav-btn span { font-size: 1.3rem; transition: 0.3s; filter: grayscale(1) opacity(0.5); }
        .nav-btn.active span { color: #fff; filter: grayscale(0) opacity(1); transform: translateY(-5px); text-shadow: 0 0 10px var(--accent-glow); }
        .nav-btn.active::after { content: ''; position: absolute; bottom: -5px; width: 4px; height: 4px; background: var(--accent); border-radius: 50%; }

        /* INCUBATOR STYLES */
        .incubator-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 20px; position: relative; }
        .capsule { 
            width: 200px; height: 320px; 
            background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
            border: 2px solid rgba(255,255,255,0.1); 
            border-radius: 100px; 
            position: relative; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5), inset 0 0 20px rgba(255,255,255,0.05);
            overflow: hidden;
            transition: 0.5s;
        }
        .capsule.active { border-color: var(--brc-color); box-shadow: 0 0 30px rgba(255, 51, 255, 0.2), inset 0 0 20px rgba(255, 51, 255, 0.1); }
        .capsule::before { content: ''; position: absolute; top: 20px; left: 40px; width: 30px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 20px; transform: rotate(10deg); filter: blur(5px); pointer-events: none; }
        
        .capsule-content { z-index: 2; display: flex; flex-direction: column; align-items: center; }
        .inc-item-img { width: 120px; height: 120px; object-fit: contain; filter: drop-shadow(0 0 15px rgba(255,255,255,0.3)); animation: float 3s ease-in-out infinite; }
        .inc-placeholder { color: #555; font-weight: 700; font-size: 0.9rem; text-align: center; }
        
        .liquid { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; 
            background: linear-gradient(0deg, rgba(255, 51, 255, 0.4), transparent); 
            transition: height 1s; 
            z-index: 1; 
        }
        .capsule.active .liquid { height: 100%; }

        .farming-info { margin-top: 20px; text-align: center; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px; width: 100%; max-width: 300px; border: 1px solid rgba(255,255,255,0.05); }
        .brc-icon-lg { width: 30px; height: 30px; vertical-align: middle; border-radius: 50%; }

        /* Grid & Cards */
        .cases-grid, .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 12px; }
        .case-card, .item-card { background: var(--card); padding: 10px; border-radius: 18px; text-align: center; border: 1px solid rgba(255,255,255,0.03); transition: 0.2s; position: relative; overflow: hidden; aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .case-card:active, .item-card:active { transform: scale(0.96); background: #252529; }
        .case-img, .item-img { width: 70%; height: 70%; object-fit: cover; margin-bottom: 8px; border-radius: 16px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }
        .mutated { animation: neonPulse 2s infinite ease-in-out; border: 1px solid var(--glow-color); }
        .case-name { font-weight: 700; margin-bottom: 4px; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #eee; width: 100%; }
        .case-price { color: var(--text-muted); font-size: 0.75rem; display: flex; justify-content: center; align-items: center; gap: 4px; font-weight: 600; }
        .item-quantity { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.6); color: #fff; font-size: 0.7rem; padding: 2px 6px; border-radius: 6px; font-weight: bold; }
        .sell-btn { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); color: #fff; border: none; font-size: 0.7rem; padding: 6px; cursor: pointer; font-weight: 600; opacity: 0; transition: 0.2s; z-index: 20; }
        .item-card:hover .sell-btn { opacity: 1; }

        /* Buttons */
        .main-action-btn { background: var(--star-gradient); border: none; padding: 14px; border-radius: 16px; font-weight: 800; font-size: 0.95rem; color: #1a1a1a; cursor: pointer; box-shadow: 0 5px 15px -5px var(--accent-glow); transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; width: 100%; text-transform: uppercase; letter-spacing: 0.5px; }
        .main-action-btn:active { transform: scale(0.98); opacity: 0.9; }
        .main-action-btn:disabled { opacity: 0.6; filter: grayscale(1); cursor: not-allowed; transform: none; }
        .btn-claim { background: linear-gradient(135deg, #ff33ff, #aa00aa); color: white; box-shadow: 0 5px 15px -5px rgba(255, 51, 255, 0.5); }

        /* Modals */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 1; transition: 0.3s; }
        .modal-content { background: #151517; padding: 30px 25px; border-radius: 30px; text-align: center; border: 1px solid rgba(255,255,255,0.08); width: 90%; max-width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); animation: smoothZoom 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .close-btn { width: 100%; background: transparent; border: none; color: #666; padding: 15px; cursor: pointer; margin-top: 5px; font-weight: 600; }
        
        /* Item Select */
        .item-select-modal { position:fixed; top:0; left:0; width:100%; height:100%; background: #121214; z-index:300; display:flex; flex-direction:column; padding:20px; }
        .item-select-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(95px, 1fr)); gap:10px; overflow-y:auto; padding-bottom:50px; margin-top: 15px; }
        .select-card { background:#1e1e22; border:1px solid rgba(255,255,255,0.05); padding:10px; border-radius:15px; text-align:center; cursor:pointer; aspect-ratio:1/1; display:flex;flex-direction:column;align-items:center;justify-content:center; }
        .select-card img { width:70%; height:70%; object-fit:contain; border-radius:10px; }

        .star-icon { color: #FFD700; }
        
        /* Profile & Leaderboard */
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; background: linear-gradient(145deg, #232328, #1e1e22); padding: 25px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.05); }
        .profile-avatar { width: 75px; height: 75px; background: #2a2a2a; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 35px; overflow: hidden; border: 2px solid var(--accent); flex-shrink: 0; }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 18px; background: var(--card); margin-bottom: 8px; border-radius: 16px; align-items: center; cursor: pointer; transition: 0.2s; border: 1px solid rgba(255,255,255,0.03); }
    </style>
</head>
<body>

    <div id="loading-screen"><div class="spinner"></div></div>

    <header>
        <div class="logo">üß† BRAINROT <span>DROP</span></div>
        <div class="currencies">
            <div class="balance-badge"><span class="star-icon">‚≠êÔ∏è</span> <span id="balance">0</span></div>
            <div class="balance-badge brc-badge"><img src="https://i.ibb.co/WWB1X3WF/image.png" style="width:14px;"> <span id="brc-balance">0</span></div>
        </div>
    </header>

    <main>
        <section id="tab-cases" class="tab-content active">
            <div id="cases-grid" class="cases-grid"></div>
        </section>

        <section id="tab-incubator" class="tab-content">
            <h2 style="text-align:center; margin-bottom:20px; color:var(--brc-color); text-transform:uppercase; letter-spacing:2px; font-weight:800;">–ò–Ω–∫—É–±–∞—Ç–æ—Ä</h2>
            
            <div class="incubator-container">
                <div id="inc-capsule" class="capsule">
                    <div class="liquid"></div>
                    <div id="inc-content" class="capsule-content">
                        <div class="inc-placeholder">–ü—É—Å—Ç–æ...<br><span style="font-size:0.7rem; font-weight:400;">–ü–æ–ª–æ–∂–∏ –ø—Ä–µ–¥–º–µ—Ç</span></div>
                    </div>
                </div>
            </div>

            <div id="inc-controls" style="margin-top:25px; padding:0 20px; display:flex; flex-direction:column; gap:10px;">
                <button id="inc-put-btn" class="main-action-btn" onclick="openItemSelect('incubator')">üì• –ü–æ–ª–æ–∂–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
                
                <div id="inc-active-ui" style="display:none; width:100%;">
                    <div class="farming-info">
                        <p style="color:#aaa; font-size:0.8rem; margin-bottom:5px;">–§–∞—Ä–º–∏–Ω–≥ Brainrot Coins</p>
                        <h1 id="inc-farm-speed" style="color:#fff;">0 <small style="font-size:0.9rem; color:#666;">/ –¥–µ–Ω—å</small></h1>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button class="main-action-btn btn-claim" onclick="claimIncubator()">üí∞ –°–æ–±—Ä–∞—Ç—å</button>
                        <button class="main-action-btn" style="background:#2a2a2a; border:1px solid #444;" onclick="takeFromIncubator()">üì§ –ó–∞–±—Ä–∞—Ç—å</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-upgrade" class="tab-content">
            <div class="upgrade-container">
                <div class="upgrade-slots">
                    <div id="u-slot-left" class="u-slot" onclick="openItemSelect('left')"><p>–ü–†–ï–î–ú–ï–¢</p></div>
                    <div class="u-arrow">‚û§</div>
                    <div id="u-slot-right" class="u-slot" onclick="openItemSelect('right')"><p>–¶–ï–õ–¨</p></div>
                </div>
                <div class="quick-chance-grid">
                    <button class="chance-btn" onclick="autoSelectTarget(50)">50%</button>
                    <button class="chance-btn" onclick="autoSelectTarget(30)">30%</button>
                </div>
                <button id="upgrade-btn" class="main-action-btn" disabled style="margin-top:20px;">–ü–†–û–ö–ê–ß–ê–¢–¨</button>
            </div>
        </section>
        
        <section id="tab-games" class="tab-content">
            <div style="text-align:center; padding:20px; color:#666;">–ò–≥—Ä—ã...</div>
        </section>

        <section id="tab-profile" class="tab-content">
            <div class="profile-header">
                <div class="profile-avatar" id="prof-avatar">üë§</div>
                <div><h2 id="profile-username">User</h2></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div style="background:#1e1e22; padding:15px; border-radius:15px;">
                    <span style="color:#888; font-size:0.8rem;">Brainrot Coins</span><br>
                    <span style="font-size:1.2rem; font-weight:bold; color:var(--brc-color);" id="prof-brc">0</span>
                </div>
            </div>
        </section>

        <section id="tab-inventory" class="tab-content">
            <div id="inventory-grid" class="inventory-grid"></div>
        </section>
    </main>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('cases')"><span>üì¶</span></button>
        <button class="nav-btn" onclick="switchTab('incubator')"><span>üß™</span></button>
        <button class="nav-btn" onclick="switchTab('upgrade')"><span>üìà</span></button>
        <button class="nav-btn" onclick="switchTab('inventory')"><span>üéí</span></button>
        <button class="nav-btn" onclick="switchTab('profile')"><span>üë§</span></button>
    </nav>

    <div id="select-modal" class="item-select-modal hidden"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px"><h3 style="font-size:1.2rem;">–í—ã–±–µ—Ä–∏ –ø—Ä–µ–¥–º–µ—Ç</h3><button onclick="document.getElementById('select-modal').classList.add('hidden')" style="background:none;border:none;color:#666;font-size:2rem;line-height:1;padding:0 10px;">&times;</button></div><div id="select-grid" class="item-select-grid"></div></div>
    <div id="open-modal" class="modal hidden"><div class="modal-content"><h3 id="modal-case-name">...</h3><button id="btn-spin" class="main-action-btn">–ö–†–£–¢–ò–¢–¨</button><button class="close-btn" onclick="closeModal('open-modal')">X</button></div></div>
    <div id="drop-popup" class="popup hidden"><div class="popup-content"><h2 id="drop-title">–í–´–ü–ê–õ–û!</h2><div id="drop-results-grid" class="drop-grid single"></div><button onclick="document.getElementById('drop-popup').classList.add('hidden');load()" class="main-action-btn">–ó–ê–ë–†–ê–¢–¨</button></div></div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        function formatBalance(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num.toLocaleString();
        }

        const MUTATION_COLORS = {'Gold':'#FFD700','Diamond':'#b9f2ff','Bloodrot':'#ff3333','Candy':'#ff69b4','Rainbow':'#cc33ff','Galaxy':'#9933ff'};
        const MUTATION_MULTS = {'Gold': 1.1, 'Diamond': 1.2, 'Bloodrot': 1.5, 'Candy': 1.5, 'Rainbow': 2.0, 'Galaxy': 3.0};
        const MUT_EMOJIS = {'Gold':'ü•á','Diamond':'üíé','Bloodrot':'ü©∏','Candy':'üç¨','Rainbow':'üåà','Galaxy':'üåå'};

        window.switchTab=function(t){
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
            const navBtn = document.querySelector(`.nav-btn[onclick="switchTab('${t}')"]`);
            if(navBtn) navBtn.classList.add('active');
        }
        window.closeModal=function(id){document.getElementById(id).classList.add('hidden');}

        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp; tg.expand();
            const API = window.location.origin + '/api';
            let userId = tg.initDataUnsafe?.user?.id || 0;
            let username = tg.initDataUnsafe?.user?.username || 'Guest';
            
            let inventory = [], allItems = [], selectedCase = null;
            let currentIncubator = null;

            const el = {
                bal: document.getElementById('balance'),
                brc: document.getElementById('brc-balance'),
                cases: document.getElementById('cases-grid'),
                inv: document.getElementById('inventory-grid'),
                loader: document.getElementById('loading-screen'),
                selModal: document.getElementById('select-modal'),
                selGrid: document.getElementById('select-grid'),
                
                // Incubator
                incCapsule: document.getElementById('inc-capsule'),
                incContent: document.getElementById('inc-content'),
                incPutBtn: document.getElementById('inc-put-btn'),
                incActiveUi: document.getElementById('inc-active-ui'),
                incFarmSpeed: document.getElementById('inc-farm-speed'),
                
                profBrc: document.getElementById('prof-brc'),
                profUser: document.getElementById('profile-username'),
                profAvatar: document.getElementById('prof-avatar')
            };

            async function load(){
                try {
                    const res=await fetch(`${API}/data`,{method:'POST', body:JSON.stringify({user_id:userId, username})});
                    const d=await res.json();
                    
                    el.bal.innerText = formatBalance(d.user.balance);
                    el.brc.innerText = formatBalance(d.user.brainrot_coins);
                    el.profBrc.innerText = formatBalance(d.user.brainrot_coins);
                    el.profUser.innerText = d.user.username;
                    if(d.user.photo_url) el.profAvatar.innerHTML = `<img src="${d.user.photo_url}">`;
                    
                    inventory = d.inventory;
                    allItems = d.all_items;
                    currentIncubator = d.incubator;
                    
                    renderCases(d.cases);
                    renderInventory(d.inventory);
                    renderIncubator(d.incubator);
                    
                    setTimeout(()=>el.loader.style.display='none',500);
                } catch(e){ console.error(e); }
            }

            function renderCases(cases){
                el.cases.innerHTML=''; 
                cases.forEach(c=>{
                    const div=document.createElement('div'); div.className='case-card';
                    div.innerHTML=`<img src="${c.icon_url}" class="case-img"><div class="case-name">${c.name}</div><div class="case-price">‚≠êÔ∏è ${formatBalance(c.price)}</div>`;
                    div.onclick=()=>{selectedCase=c; document.getElementById('open-modal').classList.remove('hidden'); document.getElementById('modal-case-name').innerText=c.name;}; 
                    el.cases.appendChild(div);
                });
            }

            function renderInventory(inv){
                el.inv.innerHTML=''; 
                if(!inv.length) el.inv.innerHTML="<p style='color:#666;grid-column:1/-1;text-align:center;'>–ü—É—Å—Ç–æ</p>";
                inv.forEach(i=>{
                    const div=document.createElement('div'); div.className='item-card';
                    let mutsHtml = '';
                    if(i.muts_list && i.muts_list.length > 0) {
                        div.classList.add('mutated');
                        div.style.setProperty('--glow-color', MUTATION_COLORS[i.muts_list[0]] || '#FFD700');
                    }
                    div.innerHTML=`${mutsHtml}<span class="item-quantity">x${i.quantity}</span><img src="${i.image_url}" class="item-img"><div class="case-name">${i.name}</div>`;
                    el.inv.appendChild(div);
                });
            }

            // --- INCUBATOR LOGIC ---
            function renderIncubator(inc) {
                if (inc) {
                    el.incCapsule.classList.add('active');
                    el.incPutBtn.style.display = 'none';
                    el.incActiveUi.style.display = 'block';
                    
                    // Calc multiplier
                    let mult = 1.0;
                    let muts = inc.mutations ? inc.mutations.split(',') : [];
                    let mutsHtml = '';
                    
                    muts.forEach(m => { 
                        if(m){
                            mult *= (MUTATION_MULTS[m] || 1);
                            mutsHtml += `<span style="font-size:1.2rem;">${MUT_EMOJIS[m]||''}</span>`;
                        }
                    });
                    
                    const coinsPerDay = Math.floor(inc.price * mult * 0.10);
                    el.incFarmSpeed.innerHTML = `${formatBalance(coinsPerDay)} <small style="font-size:0.9rem; color:#666;">/ –¥–µ–Ω—å</small>`;
                    
                    let glowColor = muts.length > 0 ? (MUTATION_COLORS[muts[0]] || '#ff33ff') : '#ff33ff';
                    document.documentElement.style.setProperty('--brc-color', glowColor);

                    el.incContent.innerHTML = `
                        <img src="${inc.image_url}" class="inc-item-img">
                        <div style="margin-top:10px; font-weight:bold; color:#fff;">${inc.name}</div>
                        <div>${mutsHtml}</div>
                    `;
                } else {
                    el.incCapsule.classList.remove('active');
                    el.incPutBtn.style.display = 'block';
                    el.incActiveUi.style.display = 'none';
                    el.incContent.innerHTML = `<div class="inc-placeholder">–ü—É—Å—Ç–æ...<br><span style="font-size:0.7rem; font-weight:400;">–ü–æ–ª–æ–∂–∏ –ø—Ä–µ–¥–º–µ—Ç</span></div>`;
                }
            }

            window.openItemSelect = (mode) => {
                el.selGrid.innerHTML=''; el.selModal.classList.remove('hidden');
                let list = (mode === 'incubator') ? inventory.filter(i => i.quantity > 0) : allItems;
                
                list.forEach(i=>{
                    const div=document.createElement('div'); div.className='select-card';
                    div.innerHTML=`<img src="${i.image_url}"><span>${formatBalance(i.price)}‚≠êÔ∏è</span>`;
                    div.onclick = () => {
                         if(mode === 'incubator') putToIncubator(i);
                         // Logic for upgrade...
                         el.selModal.classList.add('hidden');
                    };
                    el.selGrid.appendChild(div);
                });
            }

            window.putToIncubator = async (item) => {
                try {
                    const res = await fetch(`${API}/incubator/put`, {
                        method: 'POST',
                        body: JSON.stringify({
                            user_id: userId, 
                            item_id: item.item_id, 
                            mutations: item.muts_list
                        })
                    });
                    const d = await res.json();
                    if(d.status === 'ok') load();
                    else tg.showAlert(d.error);
                } catch(e) { console.error(e); }
            }

            window.claimIncubator = async () => {
                try {
                    const res = await fetch(`${API}/incubator/claim`, {method:'POST', body:JSON.stringify({user_id:userId})});
                    const d = await res.json();
                    if(d.status === 'ok') {
                        if(d.added > 0) tg.showAlert(`–°–æ–±—Ä–∞–Ω–æ ${d.added} –∫–æ–∏–Ω–æ–≤!`);
                        else tg.showAlert("–ü–æ–∫–∞ –Ω–µ—á–µ–≥–æ —Å–æ–±–∏—Ä–∞—Ç—å...");
                        load();
                    }
                } catch(e){}
            }

            window.takeFromIncubator = async () => {
                if(!confirm("–ó–∞–±—Ä–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∞—Ä–º?")) return;
                try {
                    const res = await fetch(`${API}/incubator/take`, {method:'POST', body:JSON.stringify({user_id:userId})});
                    if((await res.json()).status === 'ok') load();
                } catch(e){}
            }
            
            // –†—É–ª–µ—Ç–∫–∞ –∏ –æ—Å—Ç–∞–ª—å–Ω–æ–µ (—Å–æ–∫—Ä–∞—â–µ–Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –æ—Ç–≤–µ—Ç–∞)
            document.getElementById('btn-spin').onclick = async () => {
                 try {
                    const res = await fetch(`${API}/open`,{method:'POST',body:JSON.stringify({user_id:userId, case_id:selectedCase.id, count:1})});
                    const d = await res.json();
                    if(d.error) return tg.showAlert(d.error);
                    document.getElementById('open-modal').classList.add('hidden');
                    document.getElementById('drop-popup').classList.remove('hidden');
                    const item = d.dropped[0];
                    document.getElementById('drop-results-grid').innerHTML = `<div class="drop-item"><img src="${item.image_url}"><div class="case-name">${item.name}</div></div>`;
                 } catch(e){console.error(e);}
            }

            load();
            setInterval(load, 5000); // Polling
        });
    </script>
</body>
</html>