<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brainrot Drop</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #121214; 
            --card: #1e1e22; 
            --accent: #FFD700; 
            --accent-glow: rgba(255, 215, 0, 0.3);
            --star-gradient: linear-gradient(135deg, #FFD700, #FDB931); 
            --nav-bg: rgba(30, 30, 35, 0.95); 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: #fff; font-family: 'Montserrat', sans-serif; padding-bottom: 90px; overflow-x: hidden; min-height: 100vh; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        
        /* Animations */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes smoothZoom { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes popItem { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes neonPulse { 0% { box-shadow: 0 0 5px var(--glow-color); border-color: var(--glow-color); } 50% { box-shadow: 0 0 15px var(--glow-color); border-color: #fff; } 100% { box-shadow: 0 0 5px var(--glow-color); border-color: var(--glow-color); } }

        /* Loader */
        #loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; flex-direction: column; gap: 15px;}
        .spinner { width: 45px; height: 45px; border: 4px solid rgba(255,255,255,0.05); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 0.8s ease-in-out infinite; }
        #error-msg { color: #ff5555; font-size: 0.8rem; text-align: center; padding: 20px; display: none; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(18, 18, 20, 0.9); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .logo { font-weight: 900; color: #fff; font-size: 1.1rem; letter-spacing: -0.5px; } .logo span { color: var(--accent); }
        .balance-badge { background: rgba(255, 215, 0, 0.1); color: #FFD700; font-weight: 700; border: 1px solid rgba(255, 215, 0, 0.2); padding: 6px 14px; border-radius: 20px; display: flex; align-items: center; gap: 6px; font-size: 0.95rem; }

        /* Tabs */
        .tab-content { display: none; padding: 15px; animation: smoothZoom 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); min-height: calc(100vh - 160px); }
        .tab-content.active { display: block; }

        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--nav-bg); backdrop-filter: blur(20px); display: flex; padding: 10px 0 25px 0; border-top: 1px solid rgba(255,255,255,0.05); z-index: 50; justify-content: space-around; border-radius: 20px 20px 0 0; }
        .nav-btn { background: none; border: none; color: #666; font-weight: 600; padding: 5px; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.6rem; gap: 4px; min-width: 50px; position: relative; }
        .nav-btn span { font-size: 1.4rem; transition: 0.3s; filter: grayscale(1) opacity(0.5); }
        .nav-btn.active span { color: #fff; filter: grayscale(0) opacity(1); transform: translateY(-5px); text-shadow: 0 0 10px var(--accent-glow); }

        /* CASES (Horizontal) */
        .cases-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 5px; }
        .case-card { background: transparent; border: none; border-radius: 16px; position: relative; overflow: hidden; aspect-ratio: 16 / 9; display: flex; flex-direction: column; justify-content: flex-end; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transform: translateZ(0); }
        .case-card:active { transform: scale(0.96); }
        .case-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; filter: brightness(0.9); }
        .case-card::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 80%; background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.6) 50%, transparent 100%); z-index: 2; pointer-events: none; }
        .case-name { position: relative; z-index: 3; font-weight: 800; margin-bottom: 2px; font-size: 0.85rem; color: #fff; width: 100%; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,1); text-transform: uppercase; }
        .case-price { position: relative; z-index: 3; color: var(--accent); font-size: 0.8rem; display: flex; justify-content: center; align-items: center; gap: 4px; font-weight: 800; padding-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,1); }
        .keys-badge { position: absolute; top: 8px; right: 8px; background: rgba(51, 255, 51, 0.9); color: #000; font-weight: 900; font-size: 0.65rem; padding: 4px 8px; border-radius: 6px; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        /* Inventory */
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(95px, 1fr)); gap: 10px; padding-bottom: 20px; }
        .item-card { background: var(--card); padding: 8px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.03); position: relative; overflow: hidden; aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .item-img { width: 75%; height: 75%; object-fit: contain; margin-bottom: 5px; border-radius: 12px; }
        .mutated { animation: neonPulse 2s infinite ease-in-out; border: 1px solid var(--glow-color); }
        .mutation-badges { position: absolute; top: 5px; left: 5px; display: flex; flex-direction: column; gap: 2px; z-index: 10; }
        .mut-badge { font-size: 0.6rem; background: rgba(0,0,0,0.7); border-radius: 4px; padding: 2px 3px; }
        .item-quantity { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: #fff; font-size: 0.65rem; padding: 2px 5px; border-radius: 4px; font-weight: bold; }

        /* General UI */
        .main-action-btn, .upgrade-btn { background: var(--star-gradient); border: none; padding: 14px; border-radius: 16px; font-weight: 800; font-size: 0.95rem; color: #1a1a1a; cursor: pointer; box-shadow: 0 5px 15px -5px var(--accent-glow); display: flex; justify-content: center; align-items: center; gap: 8px; width: 100%; text-transform: uppercase; }
        .main-action-btn:active { transform: scale(0.98); opacity: 0.9; }
        .sell-btn { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.85); color: #ff5555; border: none; font-size: 0.7rem; padding: 8px 0; cursor: pointer; font-weight: 700; opacity: 0; transition: 0.2s; z-index: 20; }
        .item-card:hover .sell-btn { opacity: 1; }

        /* Modals */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 1; transition: 0.3s; }
        .modal-content { background: #151517; padding: 25px; border-radius: 25px; text-align: center; border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 350px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: smoothZoom 0.3s ease; max-height: 90vh; overflow-y: auto; }
        .close-btn { width: 100%; background: transparent; border: none; color: #666; padding: 10px; cursor: pointer; margin-top: 10px; font-weight: 600; font-size: 0.9rem; }
        
        /* Upgrade & Games Specifics */
        .upgrade-container { display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 10px; width: 100%; max-width: 400px; margin: 0 auto; }
        .upgrade-slots { display: flex; align-items: center; gap: 15px; width: 100%; justify-content: center; }
        .u-slot { width: 90px; height: 90px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.65rem; color: #666; font-weight: 700; cursor: pointer; text-align: center; padding: 5px; overflow: hidden; }
        .u-slot.selected { border: 1px solid var(--accent); color: #fff; background: rgba(255, 215, 0, 0.05); }
        .u-slot img { width: 60%; height: 60%; object-fit: contain; margin-bottom: 5px; }
        .quick-chance-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; }
        .chance-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05); color: #888; padding: 10px 0; border-radius: 12px; font-weight: 700; font-size: 0.8rem; cursor: pointer; }

        .roulette-wrapper { position: relative; width: 220px; height: 220px; margin: 10px auto; display: flex; align-items: center; justify-content: center; }
        .progress-ring { transform: rotate(-90deg); transform-origin: 50% 50%; }
        .progress-ring-circle-bg { stroke: #1e1e22; stroke-width: 15; fill: transparent; }
        .progress-ring-circle { stroke: #FFD700; stroke-width: 15; fill: transparent; stroke-dasharray: 628; stroke-dashoffset: 628; transition: stroke-dashoffset 0.5s; filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); }
        .static-center { position: absolute; width: 170px; height: 170px; background: #151517; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 2; overflow: hidden; }
        .center-logo { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; opacity: 0.3; z-index: 1; }
        .center-content { position: absolute; z-index: 3; text-align: center; }
        .chance-text { font-size: 2.2rem; font-weight: 900; color: #fff; line-height: 1; }
        .result-layer { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: rgba(0,0,0,0.9); z-index: 10; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px); }
        .result-layer.show { opacity: 1; }
        .text-win { color: #33ff33; font-weight: 900; font-size: 1.8rem; } .text-lose { color: #ff3333; font-weight: 900; font-size: 1.8rem; }

        .game-table-container { width: 100%; background: #252529; border: 4px solid #3a3a40; border-radius: 30px; padding: 20px 10px; position: relative; display: flex; justify-content: space-between; align-items: center; min-height: 180px; margin-bottom: 20px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        .player-zone { display: flex; flex-direction: column; align-items: center; width: 45%; }
        .player-avatar { width: 50px; height: 50px; border-radius: 50%; background: #444; border: 2px solid var(--accent); margin-bottom: 8px; overflow: hidden; }
        .player-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .hand-wrapper { font-size: 3rem; height: 50px; display: flex; align-items: center; justify-content: center; margin-top: 10px; }
        .hand-left { display: inline-block; } .hand-right { display: inline-block; transform: scaleX(-1); }
        .hand-shaking-left { animation: handShakeLeft 0.5s infinite alternate ease-in-out; } .hand-shaking-right { animation: handShakeRight 0.5s infinite alternate ease-in-out; }
        .hand-spinner { display: inline-block; transform: none !important; animation: diceSpin 1s linear infinite; }
        .vs-divider { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-weight: 900; color: rgba(255,255,255,0.1); font-size: 1.5rem; }
        .game-controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; width: 100%; }
        .move-btn { font-size: 2rem; padding: 15px 0; background: #2a2a2a; border: 1px solid rgba(255,255,255,0.05); border-radius: 15px; color: #fff; cursor: pointer; }
        
        .profile-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; background: linear-gradient(145deg, #232328, #1e1e22); padding: 20px; border-radius: 20px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 15px; background: var(--card); margin-bottom: 8px; border-radius: 14px; align-items: center; }
        .star-icon { color: #FFD700; }
        
        .item-select-modal { position:fixed; top:0; left:0; width:100%; height:100%; background: #121214; z-index:300; display:flex; flex-direction:column; padding:20px; }
        .item-select-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap:10px; overflow-y:auto; padding-bottom:50px; margin-top: 15px; }
        .select-card { background:#1e1e22; border:1px solid rgba(255,255,255,0.05); padding:8px; border-radius:12px; text-align:center; cursor:pointer; aspect-ratio:1/1; display:flex;flex-direction:column;align-items:center;justify-content:center; }
        .select-card img { width:70%; height:70%; object-fit:contain; border-radius:8px; margin-bottom: 5px; }

        .popup { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 400; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); opacity: 0; transition: 0.3s; }
        .popup.active { opacity: 1; display: flex; }
        .popup-content { background: #151517; padding: 30px; border-radius: 30px; text-align: center; border: 1px solid var(--accent); width: 90%; max-width: 400px; transform: scale(0.95); position: relative; box-shadow: 0 0 50px rgba(255, 215, 0, 0.1); }
        .drop-grid { display: grid; gap: 10px; margin-bottom: 20px; overflow-y: auto; max-height: 400px; padding: 5px; }
        .drop-grid.single { grid-template-columns: 1fr; } 
        .drop-grid.multi { grid-template-columns: repeat(3, 1fr); } 
        .drop-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; align-items: center; justify-content: center; animation: popItem 0.5s ease-out forwards; }
        .drop-item img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px; }
        
        #multi-roulette-container { width: 100%; max-height: 250px; overflow-y: hidden; display: none; margin-bottom: 15px; border-radius: 12px; background: #000; border: 1px solid #333; }
        .case-roulette-row { width: 100%; height: 90px; position: relative; overflow: hidden; border-bottom: 1px solid #222; background: #111; }
        .roulette-center-line { position: absolute; left: 50%; top: 0; bottom: 0; width: 3px; background: #fff; z-index: 10; transform: translateX(-50%); box-shadow: 0 0 10px #fff; }
        .roulette-track { display: flex; height: 100%; align-items: center; will-change: transform; }
        .roulette-card { width: 80px; height: 80px; background: #1a1a1a; border: 1px solid #333; margin: 0 4px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .roulette-card img { width: 60px; height: 60px; object-fit: contain; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <div id="error-msg"></div>
    </div>

    <header>
        <div class="logo">BRAINROT <span>DROP</span></div>
        <div class="balance-badge"><span class="star-icon">‚≠êÔ∏è</span> <span id="balance">0</span></div>
    </header>

    <main>
        <!-- CASES -->
        <section id="tab-cases" class="tab-content active"><div id="cases-grid" class="cases-grid"></div></section>
        
        <!-- GAMES -->
        <section id="tab-games" class="tab-content">
            <div id="active-game-ui" style="display:none; flex-direction:column; align-items:center; width:100%;">
                <h2 id="game-status-text" style="font-size: 1.1rem; margin-bottom: 10px;">–û–∂–∏–¥–∞–Ω–∏–µ...</h2>
                <div class="game-table-container">
                    <div class="vs-divider">VS</div>
                    <div class="player-zone"><div class="player-avatar" id="avatar-left">üë§</div><div class="player-name" id="name-left">–í—ã</div><div class="hand-wrapper"><span id="hand-left" class="hand-left">ü§ú</span></div></div>
                    <div class="player-zone"><div class="player-avatar" id="avatar-right">üë§</div><div class="player-name" id="name-right">–°–æ–ø–µ—Ä–Ω–∏–∫</div><div class="hand-wrapper"><span id="hand-right" class="hand-right">ü§ú</span></div></div>
                </div>
                <div id="game-loading-spinner" class="spinner" style="display:none; margin-bottom:20px;"></div>
                <div id="game-controls" class="game-controls"></div>
                <div style="margin-top: 15px; display:flex; gap:10px;">
                    <button id="game-exit-btn" class="btn-secondary-danger" onclick="exitGame()" style="display:none;">–í—ã–π—Ç–∏</button>
                    <button id="game-cancel-btn" class="btn-secondary-danger" style="display:none" onclick="cancelActiveGame()">‚õî –û—Ç–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>
            <div id="games-lobby">
                <div style="display:flex; gap:10px; margin:10px;"><button class="main-action-btn" onclick="showCreateGameModal()">‚ûï –°–æ–∑–¥–∞—Ç—å –ò–≥—Ä—É</button></div>
                <div id="games-list" class="games-list"></div>
            </div>
        </section>

        <!-- UPGRADE -->
        <section id="tab-upgrade" class="tab-content">
            <h2 style="text-align:center;margin-bottom:15px;color:var(--accent); font-size: 1.5rem; text-transform:uppercase; letter-spacing:1px; font-weight:800;">–ê–ø–≥—Ä–µ–π–¥</h2>
            <div class="upgrade-container">
                <div class="upgrade-slots"><div id="u-slot-left" class="u-slot" onclick="openItemSelect('left')"><p>–ü–†–ï–î–ú–ï–¢</p></div><div class="u-arrow">‚û§</div><div id="u-slot-right" class="u-slot" onclick="openItemSelect('right')"><p>–¶–ï–õ–¨</p></div></div>
                <div class="quick-chance-grid"><button class="chance-btn" onclick="autoSelectTarget(50)">50%</button><button class="chance-btn" onclick="autoSelectTarget(30)">30%</button><button class="chance-btn" onclick="autoSelectTarget(20)">20%</button><button class="chance-btn" onclick="autoSelectTarget(10)">10%</button></div>
                <div class="roulette-wrapper">
                    <div class="roulette-marker"></div>
                    <svg class="progress-ring" width="220" height="220"><circle class="progress-ring-circle-bg" cx="110" cy="110" r="100"/><circle id="upgrade-circle-fg" class="progress-ring-circle" cx="110" cy="110" r="100"/></svg>
                    <div class="static-center"><img src="https://i.ibb.co/rKS1f8X3/unnamed-1.jpg" class="center-logo"><div class="center-content"><div class="chance-text" id="u-chance">0%</div><div class="chance-sub">—à–∞–Ω—Å</div></div><div id="resultLayer" class="result-layer"><span id="resultText"></span></div></div>
                </div>
                <button id="upgrade-btn" class="upgrade-btn" disabled>–ü–†–û–ö–ê–ß–ê–¢–¨</button>
            </div>
        </section>

        <!-- PROFILE -->
        <section id="tab-profile" class="tab-content">
            <button id="back-to-my-profile" class="close-btn" style="display:none; text-align:left; color: var(--accent);" onclick="load()">‚¨Ö –í–µ—Ä–Ω—É—Ç—å—Å—è</button>
            <div class="profile-header"><div class="profile-avatar" id="prof-avatar">üë§</div><div><h2 id="profile-username">User</h2><span style="color:#666;font-size:0.8rem;font-weight:600;">–ò–≥—Ä–æ–∫</span></div></div>
            <div class="stat-grid">
                <div class="stat-card"><span class="stat-val" id="prof-balance">0</span><span class="stat-label">–ë–∞–ª–∞–Ω—Å</span></div>
                <div class="stat-card"><span class="stat-val" id="prof-networth">0</span><span class="stat-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ</span></div>
                <div class="stat-card"><span class="stat-val" id="prof-cases">0</span><span class="stat-label">–ö–µ–π—Å–æ–≤</span></div>
                <div class="stat-card"><span class="stat-val" id="prof-days">0</span><span class="stat-label">–î–Ω–µ–π</span></div>
            </div>
            <div id="prof-best-container" style="margin-top: 20px;"><h3 style="margin-bottom: 10px; font-size: 1.1rem; color: #eee;">üèÜ –õ—É—á—à–∏–π –¥—Ä–æ–ø</h3><div id="prof-best-drop"><div style="text-align:center; color:#555; padding:10px; font-size:0.9rem;">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div></div></div>
            <div id="prof-inv-container" style="display: none; margin-top: 20px;"><button id="btn-view-prof-inv" class="main-action-btn" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; margin-bottom: 15px;">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button><div id="prof-inventory" class="inventory-grid" style="display: none;"></div></div>
        </section>

        <!-- LEADERBOARD -->
        <section id="tab-leaderboard" class="tab-content">
            <h2 style="text-align:center;margin-bottom:20px; font-size: 1.5rem; color: var(--accent);">üèÜ –¢–æ–ø –ë–æ–≥–∞—á–µ–π</h2>
            <div id="leaderboard-list"></div>
        </section>

        <!-- INVENTORY -->
        <section id="tab-inventory" class="tab-content">
            <div class="sell-all-container"><button class="main-action-btn" onclick="sellAllItems()">‚ôªÔ∏è –ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë</button></div>
            <div id="inventory-grid" class="inventory-grid"></div>
        </section>
    </main>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('cases')"><span>üì¶</span></button>
        <button class="nav-btn" onclick="switchTab('upgrade')"><span>üìà</span></button>
        <button class="nav-btn" onclick="switchTab('games')"><span>üéÆ</span></button>
        <button class="nav-btn" onclick="switchTab('inventory')"><span>üéí</span></button>
        <button class="nav-btn" onclick="switchTab('leaderboard')"><span>üèÜ</span></button>
        <button class="nav-btn" onclick="switchTab('profile')"><span>üë§</span></button>
    </nav>

    <!-- HIDDEN ELEMENTS -->
    <div id="select-modal" class="item-select-modal hidden"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px"><h3 style="font-size:1.2rem;">–í—ã–±–µ—Ä–∏ –ø—Ä–µ–¥–º–µ—Ç</h3><button onclick="document.getElementById('select-modal').classList.add('hidden')" style="background:none;border:none;color:#666;font-size:2rem;line-height:1;padding:0 10px;">&times;</button></div><div id="select-grid" class="item-select-grid"></div></div>
    
    <div id="create-game-modal" class="modal hidden">
        <div class="modal-content">
            <h3>–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</h3>
            <div style="margin:15px 0; display:flex; gap:8px;"><button class="nav-btn active" style="flex:1; background:rgba(255,255,255,0.05); border-radius:12px; height:50px;" onclick="selGameType='rps'; this.parentElement.children[1].classList.remove('active'); this.classList.add('active')">‚úÇÔ∏è –ö–ù–ë</button><button class="nav-btn" style="flex:1; background:rgba(255,255,255,0.05); border-radius:12px; height:50px;" onclick="selGameType='even_odd'; this.parentElement.children[0].classList.remove('active'); this.classList.add('active')">üé≤ –ß–µ—Ç/–ù–µ—á–µ—Ç</button></div>
            <div style="background:rgba(255,255,255,0.03); border-radius:12px; padding:5px; margin:10px 0; display:flex;"><button id="btn-wager-money" class="nav-btn active" style="flex:1; border-radius:10px; font-size:0.9rem;" onclick="setWagerType('money')">üí∞ –î–µ–Ω—å–≥–∏</button><button id="btn-wager-item" class="nav-btn" style="flex:1; border-radius:10px; font-size:0.9rem;" onclick="setWagerType('item')">üî´ –ü—Ä–µ–¥–º–µ—Ç</button></div>
            <div id="wager-money-block" style="margin:20px 0"><label style="color:#888; font-size:0.9rem; display:block; text-align:left; margin-bottom:5px;">–°—Ç–∞–≤–∫–∞:</label><input type="number" id="wager-amount" value="100" style="width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.1); background:#151517; color:#fff; font-size:1rem; outline:none;"></div>
            <div id="wager-item-block" style="margin:20px 0; display:none;"><div id="selected-wager-item" onclick="openItemSelect('wager')" style="background:rgba(255,255,255,0.05); border:1px dashed #666; border-radius:12px; padding:15px; cursor:pointer;"><p style="color:#aaa;">–í—ã–±—Ä–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç</p></div></div>
            <button class="main-action-btn" onclick="createGame()">–°–û–ó–î–ê–¢–¨</button><button class="close-btn" onclick="closeModal('create-game-modal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="open-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-case-name">...</h3>
            <p class="modal-price">–¶–µ–Ω–∞: <span class="star-icon">‚≠êÔ∏è</span> <span id="modal-case-price">0</span></p>
            <div class="slider-container" style="background:rgba(255,255,255,0.03); padding:10px; border-radius:15px; margin-bottom:15px;"><div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem; color:#aaa;"><span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span><span id="slider-count" style="color:#fff; font-weight:bold;">1</span></div><input type="range" min="1" max="50" value="1" id="case-slider" oninput="updateSlider(this.value)" style="width:100%; accent-color:var(--accent);"></div>
            <div id="multi-roulette-container"></div>
            <div class="actions-grid"><button id="btn-fast" class="main-action-btn">‚è© –ë–´–°–¢–†–û</button><button id="btn-spin" class="main-action-btn">üé∞ –ö–†–£–¢–ò–¢–¨</button></div>
            <button class="close-btn" onclick="closeModal('open-modal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="sell-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="sell-item-name">–ü—Ä–æ–¥–∞–∂–∞</h3>
            <img id="sell-item-img" src="" class="modal-main-img" style="width:120px; height:120px; border-radius:20px;">
            <p style="color:#888; margin-bottom:15px;">–í –Ω–∞–ª–∏—á–∏–∏: <span id="sell-owned-count" style="color:#fff; font-weight:bold;">0</span></p>
            <div class="slider-container" id="sell-slider-container" style="background:rgba(255,255,255,0.03); padding:10px; border-radius:15px; margin-bottom:15px;"><div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem; color:#aaa;"><span>–ü—Ä–æ–¥–∞—Ç—å:</span><span id="sell-slider-count" style="color:#fff; font-weight:bold;">1</span></div><input type="range" min="1" max="1" value="1" id="sell-slider" oninput="updateSellSlider(this.value)" style="width:100%; accent-color:var(--accent);"></div>
            <button id="confirm-sell-btn" class="main-action-btn" style="background:#2a2a2a; color:#ff5555; border:1px solid rgba(255,55,55,0.3);">–ü–†–û–î–ê–¢–¨ –ó–ê <span class="star-icon">‚≠êÔ∏è</span> <span id="total-sell-price">0</span></button>
            <button class="close-btn" onclick="closeModal('sell-modal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="details-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="det-item-name" style="color:var(--accent); text-transform:uppercase; margin-bottom:10px;">NAME</h3>
            <img id="det-item-img" src="" style="width:120px;height:120px;object-fit:cover;border-radius:20px;margin-bottom:20px;">
            <div id="det-rarity-badge" style="margin-bottom:15px; font-weight:800; padding:5px 10px; border-radius:8px; display:inline-block;">RARITY</div>
            <div class="info-row"><span class="info-label">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞:</span><span class="info-value"><span class="star-icon">‚≠êÔ∏è</span> <span id="det-base-price">0</span></span></div>
            <div id="det-mutations-block" style="margin-bottom:10px;"></div>
            <div class="info-row" style="border-top:1px solid rgba(255,255,255,0.1); padding-top:10px; margin-top:10px;"><span class="info-label">–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞:</span><span class="info-value" style="color:#33ff33; font-size:1.1rem;"><span class="star-icon">‚≠êÔ∏è</span> <span id="det-final-price">0</span></span></div>
            <button class="close-btn" onclick="closeModal('details-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="drop-popup" class="popup hidden">
        <div class="popup-content"><div class="glow-bg"></div><h2 id="drop-title" style="font-size:1.8rem; margin-bottom:15px; text-shadow:0 0 10px rgba(255,215,0,0.5);">üéâ –í–´–ü–ê–õ–û!</h2><div id="drop-results-grid" class="drop-grid single"></div><button id="claim-btn" class="main-action-btn">–ó–ê–ë–†–ê–¢–¨</button></div>
    </div>

    <audio id="audio-player"></audio>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // CONFIG
        const tg = window.Telegram.WebApp; 
        tg.expand();
        const API = window.location.origin + '/api';
        
        // UTILS
        const formatBalance = n => n >= 1e6 ? (n/1e6).toFixed(1)+'M' : n >= 1e3 ? (n/1e3).toFixed(1)+'k' : n.toLocaleString();
        const MUT_COLORS = {'Gold':'#FFD700','Diamond':'#b9f2ff','Bloodrot':'#ff3333','Candy':'#ff69b4','Rainbow':'#cc33ff','Galaxy':'#9933ff'};
        const MUT_MULTS = {'Gold':1.1,'Diamond':1.2,'Bloodrot':1.5,'Candy':1.5,'Rainbow':2.0,'Galaxy':3.0};
        const RARITY_ORDER = {'Secret':7,'Immortal':6,'Legendary':5,'Mythical':4,'Rare':3,'Uncommon':2,'Common':1};
        const RARITY_HEX = {'Common':'#666','Uncommon':'#5e98d9','Rare':'#4b69ff','Mythical':'#d32ce6','Legendary':'#ff9900','Immortal':'#00ffff','Secret':'#ff0000'};
        const MUT_EMOJIS = {'Gold':'ü•á','Diamond':'üíé','Bloodrot':'ü©∏','Candy':'üç¨','Rainbow':'üåà','Galaxy':'üåå'};
        const GAME_EMOJIS = {'rock':'ü™®','scissors':'‚úÇÔ∏è','paper':'üìÑ','1':'1','2':'2','odd':'–ù–µ—á–µ—Ç','even':'–ß–µ—Ç'};
        
        let userId = tg.initDataUnsafe?.user?.id || 0;
        let username = tg.initDataUnsafe?.user?.username || 'Guest';
        let photoUrl = tg.initDataUnsafe?.user?.photo_url || '';
        
        // GLOBAL STATE
        let allItems=[], inventory=[], allItemsSorted=[], currentBal=0;
        let selectedCase={id:0, price:0, keys:0}, openCount=1;
        let upgMy=null, upgTarget=null;
        let sellingItem=null, sellCount=1;
        let selGameType='rps', activeGameId=null, wagerType='money', selWagerItem=null;

        // UI REFS
        const el = {
            loader: document.getElementById('loading-screen'),
            err: document.getElementById('error-msg'),
            bal: document.getElementById('balance'),
            cases: document.getElementById('cases-grid'),
            inv: document.getElementById('inventory-grid'),
            lb: document.getElementById('leaderboard-list'),
            gamesList: document.getElementById('games-list'),
            gameUi: document.getElementById('active-game-ui'),
            gamesLobby: document.getElementById('games-lobby'),
            gameControls: document.getElementById('game-controls'),
            gameStatus: document.getElementById('game-status-text'),
            gameSpinner: document.getElementById('game-loading-spinner'),
            gameExitBtn: document.getElementById('game-exit-btn'),
            gameCancelBtn: document.getElementById('game-cancel-btn'),
            avLeft: document.getElementById('avatar-left'), nameLeft: document.getElementById('name-left'), handLeft: document.getElementById('hand-left'),
            avRight: document.getElementById('avatar-right'), nameRight: document.getElementById('name-right'), handRight: document.getElementById('hand-right'),
            openModal: document.getElementById('open-modal'), slider: document.getElementById('case-slider'), sliderVal: document.getElementById('slider-count'), mPrice: document.getElementById('modal-case-price'),
            popup: document.getElementById('drop-popup'), dropGrid: document.getElementById('drop-results-grid'), multiBox: document.getElementById('multi-roulette-container'),
            btnFast: document.getElementById('btn-fast'), btnSpin: document.getElementById('btn-spin'),
            profUser: document.getElementById('profile-username'), profBal: document.getElementById('prof-balance'), profNet: document.getElementById('prof-networth'), profCases: document.getElementById('prof-cases'), profDays: document.getElementById('prof-days'), profAvatar: document.getElementById('prof-avatar'), profBestDrop: document.getElementById('prof-best-drop'), profInventory: document.getElementById('prof-inventory'), profInvContainer: document.getElementById('prof-inv-container'), btnViewProfInv: document.getElementById('btn-view-prof-inv'), backBtn: document.getElementById('back-to-my-profile'), profBestContainer: document.getElementById('prof-best-container'),
            selModal: document.getElementById('select-modal'), selGrid: document.getElementById('select-grid'),
            uLeft: document.getElementById('u-slot-left'), uRight: document.getElementById('u-slot-right'), uBtn: document.getElementById('upgrade-btn'), uChance: document.getElementById('u-chance'), upgCircleFg: document.getElementById('upgrade-circle-fg'), resultLayer: document.getElementById('resultLayer'), resultText: document.getElementById('resultText'),
            sellModal: document.getElementById('sell-modal'), sellName: document.getElementById('sell-item-name'), sellImg: document.getElementById('sell-item-img'), sellOwned: document.getElementById('sell-owned-count'), sellSlider: document.getElementById('sell-slider'), sellSliderVal: document.getElementById('sell-slider-count'), sellTotalBtn: document.getElementById('total-sell-price'), sellSliderContainer: document.getElementById('sell-slider-container'), confirmSellBtn: document.getElementById('confirm-sell-btn'),
            detModal: document.getElementById('details-modal'), detName: document.getElementById('det-item-name'), detImg: document.getElementById('det-item-img'), detBase: document.getElementById('det-base-price'), detMuts: document.getElementById('det-mutations-block'), detFinal: document.getElementById('det-final-price'), detRarity: document.getElementById('det-rarity-badge'),
            wagerMoneyBlock: document.getElementById('wager-money-block'), wagerItemBlock: document.getElementById('wager-item-block'), selWagerItemDiv: document.getElementById('selected-wager-item'), btnWagerMoney: document.getElementById('btn-wager-money'), btnWagerItem: document.getElementById('btn-wager-item')
        };

        // CORE FUNCTIONS
        function showError(msg) {
            el.err.style.display = 'block';
            el.err.innerText = "–û—à–∏–±–∫–∞: " + msg;
            alert("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: " + msg); 
        }

        async function safeFetch(url, body) {
            try {
                const res = await fetch(API + url, { method: 'POST', body: JSON.stringify(body) });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (e) {
                console.error(e);
                // Don't alert on background polls
                if (!url.includes('games/list') && !url.includes('games/status')) showError(e.message);
                return { error: e.message };
            }
        }

        window.switchTab = (t) => {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
            if(t !== 'profile') el.backBtn.style.display = 'none';
            const btn = document.querySelector(`.nav-btn[onclick="switchTab('${t}')"]`);
            if(btn) btn.classList.add('active');
        };

        window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('active'); };

        function createItemCardHTML(item, isClickable=true, onClickAction=null) {
            const div = document.createElement('div'); 
            div.className = `item-card rarity-${item.rarity}`;
            let mutsHtml = ''; let mList = item.muts_list || [];
            if(!mList.length && item.mutations) mList = typeof item.mutations === 'string' ? item.mutations.split(',').filter(x=>x) : item.mutations;
            if(mList.length > 0) {
                div.classList.add('mutated'); 
                const color = MUT_COLORS[mList[0]] || '#FFD700';
                div.style.setProperty('--glow-color', color);
                mutsHtml = '<div class="mutation-badges">'; mList.forEach(m => { mutsHtml += `<span class="mut-badge">${MUT_EMOJIS[m] || m}</span>`; }); mutsHtml += '</div>';
            }
            const price = item.sell_price || item.price;
            let btnHtml = (isClickable && !onClickAction) ? `<button class="sell-btn" onclick="openSellModal(${item.item_id}, '${mList.join(',')}')">–ü–†–û–î–ê–¢–¨: ${formatBalance(price)}</button>` : '';
            let qtyHtml = item.quantity > 0 ? `<span class="item-quantity">x${item.quantity}</span>` : '';
            div.innerHTML = `${mutsHtml}${qtyHtml}<img src="${item.image_url}" class="item-img"><div style="font-size:0.65rem;color:#ddd;font-weight:700;white-space:nowrap;overflow:hidden;width:100%;text-overflow:ellipsis;">${item.name}</div>${btnHtml}`;
            if(isClickable) div.onclick = (e) => { if(!e.target.closest('.sell-btn')) onClickAction ? onClickAction(item) : viewItemDetails(item); };
            return div;
        }

        function sortItems(items) { return items.sort((a,b) => { let rA = RARITY_ORDER[a.rarity] || 0; let rB = RARITY_ORDER[b.rarity] || 0; return rB !== rA ? rB - rA : b.price - a.price; }); }

        // MAIN RENDERER
        function renderAll(d, init) {
            if(d.user) {
                currentBal = d.user.balance;
                el.bal.innerText = formatBalance(currentBal);
                if(el.backBtn.style.display === 'none') renderProfile(d.user, d.inventory, true, d.user.best_item);
            }
            // Cases
            if(init) {
                el.cases.innerHTML = '';
                d.cases.forEach(c => {
                    const div = document.createElement('div'); div.className = 'case-card';
                    const keyBadge = (c.keys > 0) ? `<div class="keys-badge">üîë ${c.keys}</div>` : '';
                    div.innerHTML = `${keyBadge}<img src="${c.icon_url}" class="case-img"><div class="case-name">${c.name}</div><div class="case-price">‚≠êÔ∏è ${formatBalance(c.price)}</div>`;
                    div.onclick = () => { selectedCase = c; showOpenModal(); };
                    el.cases.appendChild(div);
                });
            }
            // Inventory
            if(init || JSON.stringify(d.inventory) !== el.inv.dataset.hash) {
                el.inv.dataset.hash = JSON.stringify(d.inventory);
                el.inv.innerHTML = '';
                inventory = sortItems(d.inventory);
                if(!inventory.length) el.inv.innerHTML = "<p style='color:#666;grid-column:1/-1;text-align:center;'>–ü—É—Å—Ç–æ</p>";
                inventory.forEach(i => el.inv.appendChild(createItemCardHTML(i)));
            }
            // Leaderboard
            if(d.leaderboard) {
                el.lb.innerHTML = '';
                d.leaderboard.forEach((u, i) => {
                    const av = u.photo_url ? `<img src="${u.photo_url}" class="lb-avatar">` : '<span class="lb-avatar" style="background:#444;display:inline-block;text-align:center;line-height:35px;">üë§</span>';
                    el.lb.innerHTML += `<div class="leaderboard-item" onclick="viewProfile(${u.tg_id})"><div><span style="font-weight:900;color:#666;width:30px;display:inline-block;">#${i+1}</span>${av}<span>${u.username}</span></div><span style="color:#FFD700;font-weight:bold">${formatBalance(u.net_worth)} ‚≠êÔ∏è</span></div>`;
                });
            }
        }

        // INITIAL LOAD
        async function load() {
            try {
                const d = await safeFetch('/data', { user_id: userId, username, photo_url: photoUrl });
                if(d.error) throw new Error(d.error);
                allItems = d.case_items || [];
                allItemsSorted = d.all_items || [];
                renderAll(d, true);
                updateGamesList();
                pollGameStatus();
                setTimeout(() => el.loader.style.display = 'none', 500);
            } catch (e) {
                showError(e.message);
            }
        }
        
        async function autoUpdate() {
            if(!el.popup.classList.contains('active') && el.openModal.classList.contains('hidden')) {
                const d = await safeFetch('/data', { user_id: userId });
                if(!d.error) renderAll(d, false);
                if(activeGameId) pollGameStatus(); else updateGamesList();
            }
        }
        setInterval(autoUpdate, 3000);

        // --- OPEN CASE ---
        window.showOpenModal = () => {
            el.multiBox.style.display = 'none'; el.multiBox.innerHTML = '';
            el.btnFast.disabled = false; el.btnSpin.disabled = false; el.slider.disabled = false;
            el.slider.value = 1; updateSlider(1);
            el.openModal.classList.remove('hidden');
        };
        window.updateSlider = (v) => {
            openCount = parseInt(v); el.sliderVal.innerText = openCount;
            el.mPrice.innerHTML = (selectedCase.keys >= openCount) ? `<span style="color:#33ff33">–ë–ï–°–ü–õ–ê–¢–ù–û (–ö–ª—é—á–∏: ${selectedCase.keys})</span>` : `–¶–µ–Ω–∞: <span class="star-icon">‚≠êÔ∏è</span> ${formatBalance(selectedCase.price * openCount)}`;
        };
        async function runOpen(mode) {
            const price = selectedCase.price * openCount;
            if(selectedCase.keys < openCount && currentBal < price) return tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
            el.btnFast.disabled = true; el.btnSpin.disabled = true; el.slider.disabled = true;
            const d = await safeFetch('/open', { user_id: userId, case_id: selectedCase.id, count: openCount });
            if(d.error) { el.btnFast.disabled = false; el.btnSpin.disabled = false; el.slider.disabled = false; return tg.showAlert(d.error); }
            if(!d.used_keys) upBal(currentBal - price); else selectedCase.keys -= openCount;
            if(mode === 'fast') { closeModal('open-modal'); showResults(d.dropped); }
            else {
                el.multiBox.style.display = 'block'; el.multiBox.innerHTML = '';
                d.dropped.forEach((item, i) => createRoulette(item, i));
                setTimeout(() => { closeModal('open-modal'); showResults(d.dropped); }, 5500);
            }
        }
        el.btnFast.onclick = () => runOpen('fast'); el.btnSpin.onclick = () => runOpen('spin');

        function createRoulette(winItem, idx) {
            const row = document.createElement('div'); row.className = 'case-roulette-row';
            const track = document.createElement('div'); track.className = 'roulette-track';
            row.innerHTML = '<div class="roulette-center-line"></div>';
            row.appendChild(track);
            const pool = allItemsSorted.filter(i => i.case_id === selectedCase.id);
            for(let i=0; i<45; i++) {
                const item = (i === 29) ? winItem : pool[Math.floor(Math.random() * pool.length)];
                track.innerHTML += `<div class="roulette-card rarity-${item.rarity}"><img src="${item.image_url}"></div>`;
            }
            el.multiBox.appendChild(row);
            setTimeout(() => {
                track.style.transition = "transform 5s cubic-bezier(0.1, 0, 0.2, 1)";
                track.style.transform = `translateX(-${29 * 88 + 44 - el.multiBox.clientWidth/2 + Math.floor(Math.random()*40)-20}px)`;
            }, 50 + idx * 50);
        }

        function showResults(items) {
            el.popup.classList.add('active'); el.dropGrid.innerHTML = '';
            el.dropGrid.className = items.length > 1 ? 'drop-grid multi' : 'drop-grid single';
            items.forEach(item => {
                const div = document.createElement('div'); div.className = `drop-item rarity-${item.rarity}`;
                div.innerHTML = `<img src="${item.image_url}"><div style="font-weight:bold;font-size:0.8rem">${item.name}</div>`;
                if(item.mutations && item.mutations.length) {
                    const c = MUT_COLORS[item.mutations[0]];
                    div.style.border = `2px solid ${c}`; div.style.boxShadow = `0 0 10px ${c}`;
                }
                el.dropGrid.appendChild(div);
            });
        }
        document.getElementById('claim-btn').onclick = () => { el.popup.classList.remove('active'); load(); };

        // --- UPGRADE ---
        window.openItemSelect = (side) => {
            el.selGrid.innerHTML = ''; el.selModal.classList.remove('hidden');
            let list = (side === 'left' || side === 'wager') ? inventory.filter(i=>i.quantity>0) : allItemsSorted;
            if(side === 'right' && upgMy) { const r = RARITY_ORDER[upgMy.rarity] || 0; list = list.filter(i => (RARITY_ORDER[i.rarity] || 0) > r); }
            list = sortItems(list);
            if(!list.length) el.selGrid.innerHTML = "<p style='grid-column:1/-1;text-align:center;'>–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</p>";
            list.forEach(i => {
                const div = createItemCardHTML(i, true, (clicked) => {
                    if(side === 'wager') { selWagerItem = clicked; el.selWagerItemDiv.innerHTML = `<img src="${clicked.image_url}" style="width:50px;vertical-align:middle"> <b>${clicked.name}</b>`; }
                    else selectUpgradeItem(side, clicked);
                    el.selModal.classList.add('hidden');
                });
                div.className = `select-card rarity-${i.rarity}`;
                div.innerHTML = div.innerHTML.replace(/<button.*button>/,'');
                el.selGrid.appendChild(div);
            });
        };
        function selectUpgradeItem(side, item) {
            const html = `<img src="${item.image_url}"><div style="font-size:0.6rem;overflow:hidden;text-overflow:ellipsis;width:100%">${item.name}</div><p>${formatBalance(item.price)}‚≠êÔ∏è</p>`;
            if(side === 'left') { upgMy = item; el.uLeft.innerHTML = html; el.uLeft.classList.add('selected'); upgTarget = null; el.uRight.innerHTML = "<p>–¶–ï–õ–¨</p>"; el.uRight.classList.remove('selected'); }
            else { upgTarget = item; el.uRight.innerHTML = html; el.uRight.classList.add('selected'); }
            calcChance();
        }
        window.autoSelectTarget = (pct) => {
            if(!upgMy) return tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Å–≤–æ–π –ø—Ä–µ–¥–º–µ—Ç!");
            const targetP = (upgMy.sell_price * 95) / pct;
            const r = RARITY_ORDER[upgMy.rarity] || 0;
            const valid = allItemsSorted.filter(i => (RARITY_ORDER[i.rarity] || 0) > r);
            if(!valid.length) return tg.showAlert("–ù–µ—Ç —Ü–µ–ª–µ–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è!");
            const best = valid.reduce((p, c) => Math.abs(c.price - targetP) < Math.abs(p.price - targetP) ? c : p);
            selectUpgradeItem('right', best);
        };
        function calcChance() {
            if(!upgMy || !upgTarget) { el.uChance.innerText = "0%"; el.uBtn.disabled = true; el.upgCircleFg.style.strokeDashoffset = 628; return; }
            let ch = (upgMy.sell_price / upgTarget.price) * 100 * 0.95;
            if(ch > 80) ch = 80; if(ch < 1) ch = 1;
            el.uChance.innerText = ch.toFixed(2) + "%"; el.uBtn.disabled = false;
            el.upgCircleFg.style.strokeDashoffset = 628 - (ch / 100) * 628;
        }
        el.uBtn.onclick = async () => {
            el.uBtn.disabled = true; el.resultLayer.classList.remove('show');
            document.querySelector('.progress-ring').style.transition = 'none';
            document.querySelector('.progress-ring').style.transform = 'rotate(-90deg)';
            const d = await safeFetch('/upgrade', { user_id: userId, item_id: upgMy.item_id, target_id: upgTarget.id });
            if(d.error) { tg.showAlert(d.error); el.uBtn.disabled = false; return; }
            const win = d.status === 'win';
            const val = parseFloat(el.uChance.innerText);
            const stop = win ? Math.random() * val : val + Math.random() * (100 - val);
            const rot = 5 * 360 - (stop / 100 * 360);
            const ring = document.querySelector('.progress-ring');
            ring.style.transition = 'transform 4s cubic-bezier(0.15, 0, 0.2, 1)';
            ring.style.transform = `rotate(${rot - 90}deg)`;
            setTimeout(() => {
                el.resultLayer.classList.add('show');
                el.resultText.innerText = win ? "–£–°–ü–ï–•" : "–ù–ï–£–î–ê–ß–ê";
                el.resultText.className = win ? "text-win" : "text-lose";
                if(win) showResults([d.item]); else load();
                upgMy = null; upgTarget = null; el.uLeft.classList.remove('selected'); el.uRight.classList.remove('selected');
                el.uLeft.innerHTML = "<p>–ü–†–ï–î–ú–ï–¢</p>"; el.uRight.innerHTML = "<p>–¶–ï–õ–¨</p>";
                calcChance();
            }, 4050);
        };

        // --- PROFILE ---
        function renderProfile(user, items, isMe, best) {
            el.profUser.innerText = user.username;
            el.profBal.innerText = formatBalance(user.balance);
            el.profNet.innerText = formatBalance(user.net_worth);
            el.profCases.innerText = user.cases_opened;
            el.profDays.innerText = Math.ceil(Math.abs(new Date() - new Date(user.reg_date)) / 86400000);
            el.profAvatar.innerHTML = user.photo_url ? `<img src="${user.photo_url}">` : 'üë§';
            el.profBestDrop.innerHTML = '';
            if(best) {
                const c = createItemCardHTML({ ...best, quantity: 0 }, true, null);
                c.innerHTML = c.innerHTML.replace(/<button.*button>/, '');
                el.profBestDrop.appendChild(c);
            } else el.profBestDrop.innerHTML = '<div style="padding:10px;color:#555">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>';
            
            el.profInventory.innerHTML = '';
            if(items && items.length) items.forEach(i => el.profInventory.appendChild(createItemCardHTML(i, true, null)));
            else el.profInventory.innerHTML = '<div style="text-align:center;color:#555;padding:20px;">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>';
            
            if(isMe) { el.backBtn.style.display = 'none'; el.profInvContainer.style.display = 'none'; el.profBestContainer.style.display = 'block'; }
            else { el.backBtn.style.display = 'block'; el.profInvContainer.style.display = 'block'; el.btnViewProfInv.style.display = 'block'; el.profBestContainer.style.display = 'block'; }
        }
        window.viewProfile = async (tid) => {
            if(tid == userId) return switchTab('profile');
            el.loader.style.display = 'flex';
            const d = await safeFetch('/profile', { target_id: tid });
            if(d.profile) { renderProfile(d.profile, d.profile.inventory, false, d.profile.best_item); switchTab('profile'); }
            el.loader.style.display = 'none';
        };
        el.btnViewProfInv.onclick = () => { el.profInventory.style.display = 'grid'; el.btnViewProfInv.style.display = 'none'; };

        // --- GAMES ---
        window.showCreateGameModal = () => { document.getElementById('create-game-modal').classList.remove('hidden'); window.setWagerType('money'); };
        window.setWagerType = (t) => {
            wagerType = t;
            el.btnWagerMoney.classList.toggle('active', t === 'money');
            el.btnWagerItem.classList.toggle('active', t === 'item');
            el.wagerMoneyBlock.style.display = t === 'money' ? 'block' : 'none';
            el.wagerItemBlock.style.display = t === 'item' ? 'block' : 'none';
        };
        window.createGame = async () => {
            const amt = parseInt(document.getElementById('wager-amount').value);
            let p = { user_id: userId, game_type: selGameType, wager_type: wagerType, wager_amount: amt };
            if(wagerType === 'item') {
                if(!selWagerItem) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç!");
                p.wager_item_id = selWagerItem.item_id; p.wager_amount = 0;
            }
            const d = await safeFetch('/games/create', p);
            if(d.status === 'ok') { closeModal('create-game-modal'); pollGameStatus(); } else tg.showAlert("–û—à–∏–±–∫–∞: " + d.error);
        };
        async function updateGamesList() {
            if(activeGameId) return;
            const d = await safeFetch('/games/list', {});
            el.gamesList.innerHTML = '';
            if(!d.games || !d.games.length) el.gamesList.innerHTML = "<p style='color:#666;text-align:center'>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä</p>";
            else d.games.forEach(g => {
                if(g.host_id === userId || g.guest_id === userId) { activeGameId = g.id; renderActiveGame(g); return; }
                const w = g.wager_type === 'balance' ? `${g.wager_amount} ‚≠êÔ∏è` : `üì¶ ${g.item_name}`;
                el.gamesList.innerHTML += `<div class="game-card"><div style="display:flex;align-items:center"><span class="game-type-icon">${g.game_type==='rps'?'‚úÇÔ∏è':'üé≤'}</span><div><div style="font-weight:700">${g.host_name}</div><small style="color:#aaa">${w}</small></div></div><button class="main-action-btn" style="width:auto;padding:8px 20px" onclick="joinGame(${g.id})">–ò–ì–†–ê–¢–¨</button></div>`;
            });
        }
        window.joinGame = async (gid) => {
            const d = await safeFetch('/games/join', { user_id: userId, game_id: gid });
            if(d.status === 'ok') { activeGameId = gid; pollGameStatus(); } else tg.showAlert(d.error);
        };
        async function pollGameStatus() {
            const d = await safeFetch('/games/status', { user_id: userId });
            if(d.game) { activeGameId = d.game.id; renderActiveGame(d.game); }
            else if(activeGameId) { activeGameId = null; exitGame(); }
        }
        function renderActiveGame(g) {
            el.gamesLobby.style.display = 'none'; el.gameUi.style.display = 'flex';
            const isHost = g.host_tg_id === userId;
            const m1 = isHost ? g.host_move : g.guest_move;
            const m2 = isHost ? g.guest_move : g.host_move;
            el.avLeft.innerHTML = (isHost ? g.host_photo : g.guest_photo) ? `<img src="${isHost ? g.host_photo : g.guest_photo}">` : 'üë§';
            el.avRight.innerHTML = (isHost ? g.guest_photo : g.host_photo) ? `<img src="${isHost ? g.guest_photo : g.host_photo}">` : 'üë§';
            el.nameRight.innerText = isHost ? (g.guest_name || "–û–∂–∏–¥–∞–Ω–∏–µ...") : g.host_name;

            if(g.status === 'open') {
                el.gameStatus.innerText = "–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...";
                el.gameSpinner.style.display = 'block'; el.gameControls.innerHTML = '';
                el.gameCancelBtn.style.display = isHost ? 'block' : 'none'; el.gameExitBtn.style.display = 'none';
                el.handLeft.className = g.game_type==='rps' ? "hand-left hand-shaking-left" : "hand-spinner";
                el.handRight.className = g.game_type==='rps' ? "hand-right hand-shaking-right" : "hand-spinner";
                el.handLeft.innerText = g.game_type==='rps' ? "ü§ú" : "üé≤"; el.handRight.innerText = el.handLeft.innerText;
            } else if(g.status === 'playing') {
                el.gameCancelBtn.style.display = 'none'; el.gameExitBtn.style.display = 'none';
                if(!m1) {
                    el.gameStatus.innerText = "–¢–≤–æ–π —Ö–æ–¥!"; el.gameSpinner.style.display = 'none';
                    if(g.game_type === 'rps') el.gameControls.innerHTML = `<button class="move-btn" onclick="sendMove('rock')">ü™®</button><button class="move-btn" onclick="sendMove('scissors')">‚úÇÔ∏è</button><button class="move-btn" onclick="sendMove('paper')">üìÑ</button>`;
                    else el.gameControls.innerHTML = isHost ? `<button class="move-btn" onclick="sendMove('1')">1</button><button class="move-btn" onclick="sendMove('2')">2</button>` : `<button class="move-btn" onclick="sendMove('odd')">–ù–µ—á–µ—Ç</button><button class="move-btn" onclick="sendMove('even')">–ß–µ—Ç</button>`;
                } else {
                    el.gameStatus.innerText = "–ñ–¥–µ–º —Ö–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞..."; el.gameSpinner.style.display = 'block'; el.gameControls.innerHTML = '';
                }
            } else if(g.status === 'finished') {
                el.gameStatus.innerText = g.winner_id === 0 ? "ü§ù –ù–ò–ß–¨–Ø" : ((isHost && g.winner_id === g.host_id) || (!isHost && g.winner_id === g.guest_id) ? "üèÜ –ü–û–ë–ï–î–ê!" : "üíÄ –ü–û–†–ê–ñ–ï–ù–ò–ï");
                el.gameSpinner.style.display = 'none'; el.gameControls.innerHTML = ''; el.gameExitBtn.style.display = 'block';
                el.handLeft.className = "hand-result-no-mirror"; el.handLeft.innerText = GAME_EMOJIS[m1] || m1;
                el.handRight.className = "hand-result-no-mirror"; el.handRight.innerText = GAME_EMOJIS[m2] || m2;
            }
        }
        window.sendMove = async (mv) => { await safeFetch('/games/move', { user_id: userId, game_id: activeGameId, move: mv }); pollGameStatus(); };
        window.exitGame = async () => { if(activeGameId) await safeFetch('/games/cancel', { user_id: userId, game_id: activeGameId }); el.gameUi.style.display = 'none'; el.gamesLobby.style.display = 'block'; activeGameId = null; updateGamesList(); };
        window.cancelActiveGame = window.exitGame;

        // --- SELLING ---
        window.openSellModal = (id, muts) => {
            sellingItem = inventory.find(i => i.item_id === id && (i.mutations === muts || (!i.mutations && !muts)));
            if(!sellingItem) return;
            el.sellName.innerText = sellingItem.name; el.sellImg.src = sellingItem.image_url; el.sellOwned.innerText = sellingItem.quantity;
            el.sellSliderContainer.style.display = sellingItem.quantity > 1 ? 'block' : 'none';
            el.sellSlider.max = sellingItem.quantity; el.sellSlider.value = 1; updateSellSlider(1);
            el.sellModal.classList.remove('hidden');
        };
        window.updateSellSlider = (v) => { sellCount = parseInt(v); el.sellSliderVal.innerText = sellCount; el.sellTotalBtn.innerText = formatBalance(sellingItem.sell_price * sellCount); };
        el.confirmSellBtn.onclick = async () => {
            el.sellModal.classList.add('hidden');
            const d = await safeFetch('/sell_batch', { user_id: userId, item_id: sellingItem.item_id, count: sellCount, price_per_item: sellingItem.sell_price, mutations: sellingItem.muts_list });
            if(d.status === 'ok') load(); else tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–∞–∂–∏");
        };
        window.sellAllItems = async () => {
            if(!confirm("–ü—Ä–æ–¥–∞—Ç—å –í–°–Å?")) return;
            el.loader.style.display = 'flex';
            const d = await safeFetch('/sell_all', { user_id: userId });
            if(d.status === 'ok') { tg.showAlert(`–ü—Ä–æ–¥–∞–Ω–æ –Ω–∞ ${formatBalance(d.total)} –∑–≤–µ–∑–¥`); load(); }
            el.loader.style.display = 'none';
        };
        
        // --- ITEM DETAILS ---
        window.viewItemDetails = (item) => {
            el.detName.innerText = item.name; el.detImg.src = item.image_url; el.detBase.innerText = formatBalance(item.price);
            el.detRarity.innerText = item.rarity; el.detRarity.style.color = RARITY_HEX[item.rarity]; el.detRarity.style.border = `1px solid ${RARITY_HEX[item.rarity]}`;
            el.detMuts.innerHTML = '';
            let val = item.price;
            if(item.muts_list && item.muts_list.length) {
                item.muts_list.forEach(m => {
                    val *= MUT_MULTS[m] || 1;
                    el.detMuts.innerHTML += `<div class="info-row"><span class="mut-row" style="color:${MUT_COLORS[m]}">${MUT_EMOJIS[m]} ${m}</span><span style="color:${MUT_COLORS[m]}">x${MUT_MULTS[m]}</span></div>`;
                });
            } else el.detMuts.innerHTML = '<div style="color:#666;font-size:0.9rem">–ù–µ—Ç –º—É—Ç–∞—Ü–∏–π</div>';
            el.detFinal.innerText = formatBalance(Math.floor(val));
            el.detModal.classList.remove('hidden');
        };

        // STARTUP
        try { load(); } catch(e) { showError(e); }
    </script>
</body>
</html>