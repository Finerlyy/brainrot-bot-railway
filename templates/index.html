<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brainrot Drop DEBUG</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        body { background: #121214; color: #fff; font-family: 'Montserrat', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top: 5px solid #FFD700; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* –û–ö–ù–û –õ–û–ì–û–í */
        #debug-console {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); color: #00ff00;
            font-family: monospace; font-size: 12px;
            padding: 10px; box-sizing: border-box;
            overflow-y: auto; z-index: 9999;
            pointer-events: none; /* –ß—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∫–ª–∏–∫–∞—Ç—å —Å–∫–≤–æ–∑—å, –µ—Å–ª–∏ –Ω–∞–¥–æ */
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

    <!-- –õ–æ–≥–≥–µ—Ä –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω -->
    <div id="debug-console">Initializing Debugger...<br></div>

    <div id="loading-screen" style="text-align:center;">
        <div class="spinner"></div>
        <h3 style="color:#FFD700">–ó–ê–ì–†–£–ó–ö–ê...</h3>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // --- –§–£–ù–ö–¶–ò–Ø –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø –ù–ê –≠–ö–†–ê–ù ---
        function log(msg) {
            const consoleDiv = document.getElementById('debug-console');
            const time = new Date().toLocaleTimeString();
            consoleDiv.innerHTML += `[${time}] ${msg}\n`;
            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫ JS
        window.onerror = function(message, source, lineno, colno, error) {
            log(`‚ùå CRITICAL ERROR: ${message}\nLine: ${lineno}`);
            return false;
        };

        log("üöÄ Script started");

        document.addEventListener('DOMContentLoaded', async () => {
            log("üìÑ DOM Loaded");

            try {
                // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TG
                if (!window.Telegram || !window.Telegram.WebApp) {
                    throw new Error("Telegram WebApp SDK not found!");
                }
                const tg = window.Telegram.WebApp;
                tg.expand();
                log("‚úÖ TG SDK Init. Platform: " + (tg.platform || 'unknown'));

                // 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                let userId = 0;
                let username = "Guest";
                let photoUrl = "";

                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    userId = tg.initDataUnsafe.user.id;
                    username = tg.initDataUnsafe.user.username;
                    photoUrl = tg.initDataUnsafe.user.photo_url;
                    log(`üë§ User found: ${userId} (${username})`);
                } else {
                    log("‚ö†Ô∏è User not found in initData (Running locally?)");
                    userId = 12345; // –¢–µ—Å—Ç–æ–≤—ã–π ID
                }

                // 3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
                const API = window.location.origin + '/api';
                log(`üîó API URL: ${API}`);

                log("‚è≥ Sending POST /api/data...");
                
                const response = await fetch(`${API}/data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        username: username,
                        photo_url: photoUrl
                    })
                });

                log(`üì° Response Status: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server Error (${response.status}): ${errorText.substring(0, 100)}`);
                }

                const data = await response.json();
                log("üì¶ Data received! Keys: " + Object.keys(data).join(", "));

                if (data.user) {
                    log(`üí∞ Balance: ${data.user.balance}`);
                    document.getElementById('loading-screen').innerHTML = 
                        `<h1 style='color:#00ff00'>–£–°–ü–ï–•!</h1><p>–ë–∞–ª–∞–Ω—Å: ${data.user.balance}</p><p>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: ${data.inventory.length}</p>`;
                } else {
                    throw new Error("Invalid data structure received");
                }

            } catch (e) {
                log(`‚ùå CATCH ERROR: ${e.message}`);
                log(e.stack);
            }
        });
    </script>
</body>
</html>